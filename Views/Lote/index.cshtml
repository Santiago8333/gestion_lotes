@{
    ViewData["Title"] = "Lotes";
}
<div id="app" class="container mt-5" style="padding-top: 10px;">
    <div class="row">
        <div class="col-md-12 history bg-light border-right">
            <h1>Lotes</h1>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Numero de Lote</th>
                            <th scope="col">Marca</th>
                            <th scope="col">Modelo</th>
                            <th scope="col">Dominio</th>
                            <th scope="col">Año</th>
                            <th scope="col">Base</th>
                            <th scope="col">Fecha de Creación</th>
                            <th scope="col">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(lote, index) in lotes" :key="lote.id_lote">
                            <td>{{ index + 1 }}</td>
                            <td>{{ lote.n_lote }}</td>
                            <td>{{ lote.marca }}</td>
                            <td>{{ lote.modelo }}</td>
                            <td>{{ lote.dominio }}</td>
                            <td>{{ lote.anio }}</td>
                            <td>{{ lote.base }}</td>
                            <td>{{ formatearFecha(lote.fecha_creacion) }}</td>
                            <td>
                                <div class="dropdown position-static">
                                    <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item"  href="javascript:void(0);" v-on:click="mostrarModalModificar(lote)">
                                                <i class="fa-solid fa-pencil"></i> Modificar
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0);" class="dropdown-item" v-on:click="mostrarModalEliminar(lote)">
                                                <i class="fa-solid fa-trash"></i> Eliminar
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr v-if="lotes.length === 0">
                            <td colspan="8" class="text-center text-muted">No hay lotes cargados</td>
                        </tr>
                    </tbody>
                </table>
            </div>
             <button type="button" class="btn btn-primary agregar" data-bs-toggle="modal" data-bs-target="#agregarModal"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <nav aria-label="Page navigation" v-if="totalPaginas > 1">
        <ul class="pagination justify-content-center">
            <li class="page-item" :class="{ disabled: paginaActual === 1 }">
                <a class="page-link" href="#" v-on:click.prevent="cambiarPagina(paginaActual - 1)">Anterior</a>
            </li>
            <li class="page-item" v-for="pagina in totalPaginas" :key="pagina" :class="{ active: pagina === paginaActual }">
                <a class="page-link" href="#" v-on:click.prevent="cambiarPagina(pagina)">{{ pagina }}</a>
            </li>
            <li class="page-item" :class="{ disabled: paginaActual === totalPaginas }">
                <a class="page-link" href="#" v-on:click.prevent="cambiarPagina(paginaActual + 1)">Siguiente</a>
            </li>
        </ul>
    </nav>
    <!-- Modal eliminar-->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que deseas eliminar este usuario?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a id="confirmDeleteButton" href="#" class="btn btn-danger">Eliminar</a>
      </div>
    </div>
  </div>
</div>
<!-- Modal -->
<div class="modal fade" id="agregarModal" tabindex="-1" aria-labelledby="agregarModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="agregarModalLabel">Agregar Lote</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form v-on:submit.prevent="crearLote" id="formAgregarLote" novalidate>
      @Html.AntiForgeryToken()
        <div class="modal-body">
            <div class="mb-3">
                <label for="n_lote" class="form-label">Número de Lote</label>
                <input type="number" class="form-control" id="n_lote" name="n_lote" required>
            </div>
            <div class="mb-3">
                <label for="marca" class="form-label">Marca</label>
                <input type="text" class="form-control" id="marca" name="marca" required>
            </div>
            <div class="mb-3">
                <label for="modelo" class="form-label">Modelo</label>
                <input type="text" class="form-control" id="modelo" name="modelo" required>
            </div>
            <div class="mb-3">
                <label for="dominio" class="form-label">Dominio</label>
                <input type="text" class="form-control" id="dominio" name="dominio" required>
            </div>
            <div class="mb-3">
                <label for="anio" class="form-label">Año</label>
                <input type="text" class="form-control" id="anio" name="anio" required>
            </div>
            <div class="mb-3">
                <label for="base" class="form-label">Base</label>
                <input type="number" class="form-control" id="base" name="base" required>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar Lote</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="modificarModal" tabindex="-1" aria-labelledby="modificarModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modificarModalLabel">Modificar Lote</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form v-on:submit.prevent="modificarLote" id="formModificarLote" novalidate>
        <div class="modal-body" v-if="loteAModificar">
            <input type="hidden" name="id_lote" v-model="loteAModificar.id_lote" />
            
            <div class="mb-3">
                <label for="mod_n_lote" class="form-label">Número de Lote</label>
                <input type="number" class="form-control" id="mod_n_lote" name="n_lote" v-model="loteAModificar.n_lote" required>
            </div>
            <div class="mb-3">
                <label for="mod_marca" class="form-label">Marca</label>
                <input type="text" class="form-control" id="mod_marca" name="marca" v-model="loteAModificar.marca" required>
            </div>
            <div class="mb-3">
                <label for="mod_modelo" class="form-label">Modelo</label>
                <input type="text" class="form-control" id="mod_modelo" name="modelo" v-model="loteAModificar.modelo" required>
            </div>
            <div class="mb-3">
                <label for="mod_anio" class="form-label">Año</label>
                <input type="number" class="form-control" id="mod_anio" name="anio" v-model="loteAModificar.anio" required>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Sistema</strong>
      <small class="text-muted">justo ahora</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Cerrar"></button>
    </div>
    <div class="toast-body">
      @TempData["Mensaje"]
    </div>
  </div>


</div>


@section Scripts {
<script>
    const appConfig = {
        data() {
            return {
                lotes: [],
                paginaActual: 1,
                totalPaginas: 0,
                
                // Variables para manejar los modales
                loteAEliminar: null,
                loteAModificar: null, // Aquí guardaremos el lote que se está editando
                
                // Referencias a las instancias de Bootstrap Modal
                modalEliminarBS: null,
                modalAgregarBS: null,
                modalModificarBS: null,
                
                toastBS: null
            };
        },
        mounted() {
            this.cargarLotes();
            
            // Inicializar Toast
            const toastEl = document.getElementById('successToast');
            if (toastEl) this.toastBS = new bootstrap.Toast(toastEl);
            
            // Inicializar Modales de Bootstrap para poder abrirlos/cerrarlos desde JS
            this.modalAgregarBS = new bootstrap.Modal(document.getElementById('agregarModal'));
            this.modalModificarBS = new bootstrap.Modal(document.getElementById('modificarModal'));
            this.modalEliminarBS = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        },
        methods: {
            // --- Carga de datos ---
            async cargarLotes() {
                try {
                    const response = await fetch(`/api/lotes?pagina=${this.paginaActual}`);
                    if (!response.ok) throw new Error('Error al cargar');
                    const data = await response.json();
                    
                    this.lotes = data.lotes; 
                    this.totalPaginas = data.totalPaginas;
                    this.paginaActual = data.paginaActual;
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            // --- Paginación ---
            cambiarPagina(nuevaPagina) {
                if (nuevaPagina >= 1 && nuevaPagina <= this.totalPaginas) {
                    this.paginaActual = nuevaPagina;
                    this.cargarLotes();
                }
            },

            // --- Utilidades ---
            formatearFecha(fechaISO) {
                if (!fechaISO) return '';
                return new Date(fechaISO).toLocaleDateString('es-ES');
            },
            mostrarToast(mensaje) {
                const toastBody = document.querySelector('#successToast .toast-body');
                if(toastBody) toastBody.textContent = mensaje;
                if(this.toastBS) this.toastBS.show();
            },

            // --- Lógica del Modal CREAR ---
            async crearLote() {
                // 1. Obtener datos del form
                const form = document.getElementById('formAgregarLote');
                const formData = new FormData(form);
                
                // NOTA: Aquí deberías hacer tu fetch POST real al backend
                // Ejemplo: await fetch('/Lote/Crear', { method: 'POST', body: formData });
                
                console.log("Creando lote:", Object.fromEntries(formData));
                try {
                   
                    const response = await fetch('/api/lotes', {
                        method: 'POST',
                        body: formData
                        // No necesitas 'Content-Type', FormData lo maneja solo
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        // Si la API devuelve un error (ej. 400, 500)
                        throw new Error(data.mensaje || 'Error al procesar la solicitud.');
                    }

                    // ¡Éxito!
                    this.modalAgregarBS.hide();
                    form.reset();
                    this.mostrarToast(data.mensaje); // Mostramos el toast de éxito
                    this.cargarLotes();

                } catch (error) {
                    console.error('Error al crear lote:', error);
                    this.modalAgregarBS.hide();
                    this.mostrarToast(error.message);
                }
            },

            // --- Lógica del Modal MODIFICAR ---
            mostrarModalModificar(lote) {
                // Hacemos una COPIA del objeto para no editar la tabla en tiempo real
                this.loteAModificar = { ...lote };
                this.modalModificarBS.show();
            },

            async modificarLote() {
                // Aquí envías this.loteAModificar a tu backend
                console.log("Modificando lote:", this.loteAModificar);

                // Ejemplo Fetch:
                // await fetch('/Lote/Editar', { 
                //    method: 'POST', 
                //    headers: {'Content-Type': 'application/json'},
                //    body: JSON.stringify(this.loteAModificar) 
                // });

                this.modalModificarBS.hide();
                this.mostrarToast("Lote modificado exitosamente");
                this.cargarLotes();
            },

            // --- Lógica del Modal ELIMINAR ---
            mostrarModalEliminar(lote) {
                this.loteAEliminar = lote;
                this.modalEliminarBS.show();
                
                // Configurar el botón "Eliminar" del modal (si no usas click directo en el botón)
                const btnEliminar = document.getElementById('confirmDeleteButton');
                btnEliminar.onclick = () => this.eliminarLoteConfirmado();
            },

            async eliminarLoteConfirmado() {
                if(!this.loteAEliminar) return;

                console.log("Eliminando lote ID:", this.loteAEliminar.id_lote);
                // await fetch(`/Lote/Eliminar/${this.loteAEliminar.id_lote}`, { method: 'POST' });

                this.modalEliminarBS.hide();
                this.mostrarToast("Lote eliminado");
                this.cargarLotes();
            }
        }
    };

    const app = Vue.createApp(appConfig);
    window.appInstance = app.mount('#app');
</script>
}