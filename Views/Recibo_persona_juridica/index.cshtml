@{
    ViewData["Title"] = "Recibo Persona Juridica";
}
<link rel="stylesheet" href="https://printjs-4de6.kxcdn.com/print.min.css">
<div id="app" class="container mt-5" style="padding-top: 10px;">
    <div class="row">
        <div class="col-md-12 history bg-light border-right">
            <h1>Recibo Persona Juridica</h1>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="busqueda" class="form-label">Buscar Recibos</label>
                    <input 
                        type="text" 
                        id="busqueda"
                        class="form-control" 
                        placeholder="Escribe razon social o nÃºmero de lote..."
                        v-model="textoBusqueda"
                        v-on:input="buscarConRetraso"
                        >
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Razon Social</th>
                            <th scope="col">Apoderado Socio</th>
                            <th scope="col">Numero de Lote</th>
                            <th scope="col">Email</th>
                            <th scope="col">Domicilio</th>
                            <th scope="col">Provincia</th>
                            <th scope="col">Precio Subastado</th>
                            <th scope="col">Fecha de CreaciÃ³n</th>
                            @if (User.IsInRole("Administrador"))
                            {
                            <th scope="col">Creado Por</th>
                            }
                            <th scope="col">AcciÃ³n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(recibo, index) in recibos" :key="recibo.id_recibo_persona_juridica">
                            <td>{{ recibo.index }}</td>
                            <td>{{ recibo.razon_social }}</td>
                            <td>{{ recibo.apoderado_socio }}</td>
                            <td>{{ recibo.lote.n_lote }}</td>
                            <td>{{ recibo.email }}</td>
                            <td>{{ recibo.domicilio }}</td>
                            <td>{{ recibo.provincia }}</td>
                            <td>{{ recibo.precio_subastado }}</td>
                            <td>{{ formatearFecha(recibo.fecha_creacion) }}</td>
                            @if (User.IsInRole("Administrador"))
                            {
                                <td>{{ recibo.creado_por }}</td>
                            }
                            <td>
                                <div class="dropdown position-static">
                                    <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item"  href="javascript:void(0);" v-on:click="mostrarModalModificar(recibo)">
                                                <i class="fa-solid fa-pencil"></i> Modificar
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item"  href="javascript:void(0);" v-on:click="mostrarModalDetalle(recibo)">
                                                <i class="fa-solid fa-book"></i> Detalle
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0);" class="dropdown-item" v-on:click="imprimirRecibo(recibo)">
                                                <i class="fa-solid fa-print"></i> Imprimir
                                            </a>
                                        </li>
                                         @if (User.IsInRole("Administrador"))
                                        {
                                        <li>
                                            <a href="javascript:void(0);" class="dropdown-item" v-on:click="mostrarModalEliminar(recibo)">
                                                <i class="fa-solid fa-trash"></i> Eliminar
                                            </a>
                                        </li>
                                        }
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr v-if="recibos.length === 0">
                            <td colspan="13" class="text-center text-muted">No hay recibos cargados</td>
                        </tr>
                    </tbody>
                </table>
            </div>
             <button type="button" class="btn btn-primary agregar" data-bs-toggle="modal" data-bs-target="#agregarModal"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <nav aria-label="Page navigation" v-if="totalPaginas > 1">
        <ul class="pagination justify-content-center">
            <li class="page-item" :class="{ disabled: paginaActual === 1 }">
                <a class="page-link" href="#" v-on:click.prevent="cambiarPagina(paginaActual - 1)">Anterior</a>
            </li>
            <li class="page-item" v-for="pagina in totalPaginas" :key="pagina" :class="{ active: pagina === paginaActual }">
                <a class="page-link" href="#" v-on:click.prevent="cambiarPagina(pagina)">{{ pagina }}</a>
            </li>
            <li class="page-item" :class="{ disabled: paginaActual === totalPaginas }">
                <a class="page-link" href="#" v-on:click.prevent="cambiarPagina(paginaActual + 1)">Siguiente</a>
            </li>
        </ul>
    </nav>
<!-- Modal Agergar-->
<div class="modal fade" id="agregarModal" tabindex="-1" aria-labelledby="agregarModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="agregarModalLabel">Agregar Recibo</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
  <form  v-on:submit.prevent="crearRecibo" id="formAgregarRecibo" class="needs-validation" novalidate>
    @Html.AntiForgeryToken()
    
    <div class="card mb-3 bg-light">
        <div class="card-body">
            <label class="form-label fw-bold">Buscar Lote</label>
            
            <div class="input-group mb-2">
                <input type="text" 
                       class="form-control" 
                       v-model="busquedaLote" 
                       placeholder="Ingrese NÂ° de Lote"
                       v-on:keypress.enter.prevent="buscarLote"> 
                
                <button class="btn btn-primary" 
                        type="button" 
                        v-on:click="buscarLote" 
                        :disabled="cargando">
                    <span v-if="cargando" class="spinner-border spinner-border-sm"></span>
                    <span v-else>Buscar</span>
                </button>
                
            </div>

            <div v-if="errorBusqueda" class="text-danger small mb-2">
                {{ errorBusqueda }}
            </div>
            <div v-if="resultadosBusqueda.length > 0" class="list-group mb-3 shadow-sm">
                    <button type="button" 
                            class="list-group-item list-group-item-action"
                            v-for="lote in resultadosBusqueda" 
                            :key="lote.id"
                            v-on:click="seleccionarLote(lote)">
                        <strong>Lote NÂ° {{ lote.n_lote }}</strong> 
                        <small class="text-muted">- Precio Base: {{ lote.base }} | Marca: {{ lote.marca }}</small>
                    </button>
                </div>
            <div v-if="loteSeleccionado">
                <div class="alert alert-success d-flex justify-content-between align-items-center p-2 mb-2">
                    <div>
                        <strong>Lote NÂ°: {{ loteSeleccionado.n_lote }}</strong><br>
                        <small>Base: ${{ loteSeleccionado.base }} | Marca: {{ loteSeleccionado.marca }}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" v-on:click="limpiarLote">X</button>
                </div>

                <div class="mb-2">
                    <label for="precio_subastado" class="form-label fw-bold text-primary">Precio Final Subastado</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" 
                               class="form-control fw-bold" 
                               id="precio_subastado" 
                               name="precio_subastado" 
                               v-model="precioSubastado"
                               step="0.01"
                               required> 
                        <div class="invalid-feedback">El Precio Final Subastado es obligatorio.</div>
                    </div>
                </div>

                <input type="hidden" name="id_lote" :value="loteSeleccionado.id_lote">
            </div>
        </div>
    </div>

<h5 class="mb-3 text-secondary"><i class="bi bi-calculator"></i> LiquidaciÃ³n Total</h5>

<div class="card bg-light border-0">
    <div class="card-body">
        
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <label class="form-label small fw-bold">% Pago Lote</label>
                <div class="input-group input-group-sm">
                    <input type="number" 
                           class="form-control" 
                           id="pago_lote"
                           name="pago_lote"
                           v-model.number="porcentajeLote" 
                           min="0" max="100">
                    <span class="input-group-text">%</span>
                </div>
            </div>

            <div class="col-md-4">
                <label class="form-label small fw-bold">Pago Lote ($)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoPagoLote.toFixed(2)" 
                       readonly>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-bold">Honorarios CMCPSL (10%)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoHonorarios.toFixed(2)" 
                       readonly>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-bold">Sellado DPIP (0.6%)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoSellado.toFixed(2)" 
                       readonly>
            </div>
        </div>

        <div class="row g-3">
            
            <div class="col-md-6">
                <label class="form-label fw-bold text-primary">Total a Pagar AHORA</label>
                <div class="input-group">
                    <span class="input-group-text bg-primary text-white border-primary">$</span>
                    <input type="text" 
                           class="form-control fw-bold text-primary border-primary bg-white" 
                           :value="totalPagarAhora.toFixed(2)" 
                           readonly>
                </div>
                <small class="text-muted fst-italic">Suma: Pago Lote + Honorarios + Sellado</small>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold text-danger">Saldo Lote a Pagar (en 48hs)</label>
                <div class="input-group">
                    <span class="input-group-text bg-danger text-white border-danger">$</span>
                    <input type="text" 
                           class="form-control fw-bold text-danger border-danger bg-white" 
                           :value="saldoRestante.toFixed(2)" 
                           readonly>
                </div>
                <small class="text-muted fst-italic">Resto del valor del lote</small>
            </div>

        </div>
    </div>
</div>

<ul class="nav nav-tabs mb-3" id="pagoTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="gobierno-tab" data-bs-toggle="tab" data-bs-target="#gobierno" type="button" role="tab">
            Gob. San Luis
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="cmcpsl-tab" data-bs-toggle="tab" data-bs-target="#cmcpsl" type="button" role="tab">
            CMCPSL
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="dpip-tab" data-bs-toggle="tab" data-bs-target="#dpip" type="button" role="tab">
            DPIP
        </button>
    </li>
</ul>


<div class="tab-content" id="pagoTabsContent">

    <div class="tab-pane fade show active" id="gobierno" role="tabpanel">
        <div class="alert alert-light border p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-primary m-0">Gobierno de San Luis</h6>
                <div class="badge p-2 fs-6" 
                     :class="faltaGobierno > 0.5 ? 'bg-danger' : (faltaGobierno < -0.5 ? 'bg-warning text-dark' : 'bg-success')">
                    
                    <span v-if="faltaGobierno > 0.5">Falta: ${{ faltaGobierno.toFixed(2) }}</span>
                    <span v-else-if="faltaGobierno < -0.5">Sobran: ${{ Math.abs(faltaGobierno).toFixed(2) }}</span>
                    <span v-else>Completo <i class="bi bi-check-circle"></i></span>
                </div>
            </div>
            
            <div class="progress mb-3" style="height: 5px;">
                <div class="progress-bar" role="progressbar" 
                     :style="{ width: Math.min((sumaPagosGobierno / (montoPagoLote || 1)) * 100, 100) + '%' }"
                     :class="faltaGobierno > 0.5 ? 'bg-danger' : 'bg-success'"></div>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="form-label small fw-bold">Efectivo (ARS)</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.gobierno.efectivo">
                    </div>
                </div>
                <div class="col-6">
                    <label class="form-label small fw-bold">Transferencia (ARS)</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.gobierno.transferencia">
                    </div>
                </div>
            </div>

            <hr class="text-muted">

            <label class="form-label small fw-bold mb-1">ðŸ‡ºðŸ‡¸ DÃ³lares</label>
            <div class="row g-2 mb-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">US$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.gobierno.dolar_monto" placeholder="Monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.gobierno.dolar_cotizacion" placeholder="Valor toma">
                    </div>
                </div>
            </div>

            <label class="form-label small fw-bold mb-1">ðŸ‡ªðŸ‡º Euros</label>
            <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">â‚¬</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.gobierno.euro_monto" placeholder="Monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.gobierno.euro_cotizacion" placeholder="Valor toma">
                    </div>
                </div>
            </div>
            
            <div class="text-end text-muted small mt-2">
                Total Ingresado: <strong>${{ sumaPagosGobierno.toFixed(2) }}</strong> / Objetivo: ${{ montoPagoLote.toFixed(2) }}
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="cmcpsl" role="tabpanel">
        <div class="alert alert-light border p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-primary m-0">CMCPSL</h6>
                <div class="badge p-2 fs-6" 
                     :class="faltaCMCPSL > 0.5 ? 'bg-danger' : (faltaCMCPSL < -0.5 ? 'bg-warning text-dark' : 'bg-success')">
                    <span v-if="faltaCMCPSL > 0.5">Falta: ${{ faltaCMCPSL.toFixed(2) }}</span>
                    <span v-else-if="faltaCMCPSL < -0.5">Sobran: ${{ Math.abs(faltaCMCPSL).toFixed(2) }}</span>
                    <span v-else>Completo <i class="bi bi-check-circle"></i></span>
                </div>
            </div>

            <div class="progress mb-3" style="height: 5px;">
                <div class="progress-bar" role="progressbar" 
                     :style="{ width: Math.min((sumaPagosCMCPSL / (montoHonorarios || 1)) * 100, 100) + '%' }"
                     :class="faltaCMCPSL > 0.5 ? 'bg-danger' : 'bg-success'"></div>
            </div>
            
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="form-label small fw-bold"> Efectivo (ARS)</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.cmcpsl.efectivo">
                    </div>
                </div>
                <div class="col-6">
                    <label class="form-label small fw-bold"> Transferencia (ARS)</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.cmcpsl.transferencia">
                    </div>
                </div>
            </div>

            <hr class="text-muted">

            <label class="form-label small fw-bold mb-1">ðŸ‡ºðŸ‡¸ DÃ³lares</label>
            <div class="row g-2 mb-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">US$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.cmcpsl.dolar_monto" placeholder="Monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.cmcpsl.dolar_cotizacion" placeholder="Valor toma">
                    </div>
                </div>
            </div>

            <label class="form-label small fw-bold mb-1">ðŸ‡ªðŸ‡º Euros</label>
            <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">â‚¬</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.cmcpsl.euro_monto" placeholder="Monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.cmcpsl.euro_cotizacion" placeholder="Valor toma">
                    </div>
                </div>
            </div>

            <div class="text-end text-muted small mt-2">
                Total Ingresado: <strong>${{ sumaPagosCMCPSL.toFixed(2) }}</strong> / Objetivo: ${{ montoHonorarios.toFixed(2) }}
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="dpip" role="tabpanel">
        <div class="alert alert-light border p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-primary m-0">DPIP</h6>
                <div class="badge p-2 fs-6" 
                     :class="faltaDPIP > 0.5 ? 'bg-danger' : (faltaDPIP < -0.5 ? 'bg-warning text-dark' : 'bg-success')">
                    <span v-if="faltaDPIP > 0.5">Falta: ${{ faltaDPIP.toFixed(2) }}</span>
                    <span v-else-if="faltaDPIP < -0.5">Sobran: ${{ Math.abs(faltaDPIP).toFixed(2) }}</span>
                    <span v-else>Completo <i class="bi bi-check-circle"></i></span>
                </div>
            </div>

            <div class="progress mb-3" style="height: 5px;">
                <div class="progress-bar" role="progressbar" 
                     :style="{ width: Math.min((sumaPagosDPIP / (montoSellado || 1)) * 100, 100) + '%' }"
                     :class="faltaDPIP > 0.5 ? 'bg-danger' : 'bg-success'"></div>
            </div>
            
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="form-label small fw-bold">Efectivo (ARS)</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.dpip.efectivo">
                    </div>
                </div>
                <div class="col-6">
                    <label class="form-label small fw-bold">Transferencia (ARS)</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.dpip.transferencia">
                    </div>
                </div>
            </div>

            <hr class="text-muted">

            <label class="form-label small fw-bold mb-1">ðŸ‡ºðŸ‡¸ DÃ³lares</label>
            <div class="row g-2 mb-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">US$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.dpip.dolar_monto" placeholder="Monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.dpip.dolar_cotizacion" placeholder="Valor toma">
                    </div>
                </div>
            </div>

            <label class="form-label small fw-bold mb-1">ðŸ‡ªðŸ‡º Euros</label>
            <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">â‚¬</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.dpip.euro_monto" placeholder="Monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagos.dpip.euro_cotizacion" placeholder="Valor toma">
                    </div>
                </div>
            </div>

            <div class="text-end text-muted small mt-2">
                Total Ingresado: <strong>${{ sumaPagosDPIP.toFixed(2) }}</strong> / Objetivo: ${{ montoSellado.toFixed(2) }}
            </div>
        </div>
    </div>
</div>

    <div class="modal-body">
        <div class="row">
            
            <div class="col-md-6 mb-3">
                <label for="razon_social" class="form-label">Razon Social</label>
                <input type="text" class="form-control" id="razon_social" name="razon_social" required>
                <div class="invalid-feedback">El Razon Social es obligatorio.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="apoderado_socio" class="form-label">Apoderado Socio</label>
                <input type="text" class="form-control" id="apoderado_socio" name="apoderado_socio" required>
                <div class="invalid-feedback">El Apoderado Socio es obligatorio.</div>
            </div>

            <div class="col-md-4 mb-3">
                <label for="tipo" class="form-label">Tipo</label>
                <input type="text" class="form-control" id="tipo" name="tipo" value="CUIT" required>
                <div class="invalid-feedback">El Tipo Dni es obligatorio.</div>
            </div>
            <div class="col-md-8 mb-3">
                <label for="numero" class="form-label">Numero de Dni o Cuit</label>
                <input type="text" class="form-control" id="numero" name="numero" required>
                <div class="invalid-feedback">El Dni o Cuit es obligatorio.</div>
            </div>

            <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" required>
                <div class="invalid-feedback">El Email es obligatorio.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="telefono" class="form-label">Telefono</label>
                <input type="tel" class="form-control" id="telefono" name="telefono" required>
                <div class="invalid-feedback">El Telefono es obligatorio.</div>
            </div>

            <div class="col-12 mb-3">
                <label for="domicilio" class="form-label">Domicilio</label>
                <input type="text" class="form-control" id="domicilio" name="domicilio" required>
                <div class="invalid-feedback">El Domicilio es obligatorio.</div>
            </div>

            <div class="col-md-4 mb-3">
                <label for="codigo_postal" class="form-label">C.P.</label>
                <input type="text" class="form-control" id="codigo_postal" name="codigo_postal" required>
                <div class="invalid-feedback">El C.P. es obligatorio.</div>
            </div>
            <div class="col-md-8 mb-3">
                <label for="provincia" class="form-label">Provincia</label>
                <input type="text" class="form-control" id="provincia" name="provincia" required>
                <div class="invalid-feedback">El Provincia es obligatorio.</div>
            </div>

        </div> 
        </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar Recibo</button>
    </div>
</form>
    </div>
  </div>
</div>

 <!-- Modal detalle-->
<div class="modal fade" id="confirmDetalleModal" tabindex="-1" aria-labelledby="confirmDetalleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDetalleModalLabel">Detalle del Recibo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" v-if="reciboADetalle">
        @if (User.IsInRole("Administrador"))
                            {
                <h2 class="text-secondary">Recibo info</h2>
                    <div class="alert alert-success d-flex justify-content-between align-items-center p-2 mb-2">
                        <div>
                            <strong>ID: {{ reciboADetalle.id_recibo_persona_juridica }}</strong><br>
                            <small>
                                    <span class="text-danger fw-bold">Creado Por: {{ reciboADetalle.creado_por }}</span>
                                
                        </div>
                        
                    </div>
        }
            <div v-if="reciboADetalle.lote">
                <h2 class="text-secondary">Lote que tiene el Recibo</h2>
                <div class="alert alert-success d-flex justify-content-between align-items-center p-2 mb-2">
                    <div>
                        <strong>Lote NÂ°: {{ reciboADetalle.lote.n_lote }}</strong><br>
                        <small>@if (User.IsInRole("Administrador"))
                            {
                                <span class="text-danger fw-bold">ID: {{ reciboADetalle.lote.id_lote }}</span> <span>|</span> <span class="text-danger fw-bold">Creado Por: {{ reciboADetalle.lote.creado_por }}</span>
                            }
                            Base: ${{ reciboADetalle.lote.base }} | Marca: {{ reciboADetalle.lote.marca }} | Modelo: {{ reciboADetalle.lote.modelo }} | Dominio: {{ reciboADetalle.lote.dominio }} | Anio: {{ reciboADetalle.lote.anio }} | Base: {{ reciboADetalle.lote.base }} | Fecha de Creacion: {{ formatearFecha(reciboADetalle.lote.fecha_creacion) }} </small>
                    </div>
                    
                </div>

                <div class="mb-2">
                    <label for="precio_subastado" class="form-label fw-bold text-primary">Precio Final Subastado</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" 
                               class="form-control form-control-sm bg-white" 
                               id="precio_subastado" 
                               name="precio_subastado" 
                               v-model="precioSubastadoDetalle"
                               step="0.01"
                               readonly> 
                    </div>
                </div>


        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <label class="form-label small fw-bold">% Pago Lote</label>
                <div class="input-group input-group-sm">
                    <input type="number" 
                           class="form-control form-control-sm bg-white" 
                           id="pago_lote"
                           name="pago_lote"
                           v-model.number="porcentajeLoteDetalle" 
                           min="0" max="100" readonly>
                    <span class="input-group-text">%</span>
                </div>
            </div>

            <div class="col-md-4">
                <label class="form-label small fw-bold">Pago Lote ($)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoPagoLoteDetalle.toFixed(2)" 
                       readonly>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-bold">Honorarios CMCPSL (10%)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoHonorariosDetalle.toFixed(2)"
                       readonly>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-bold">Sellado DPIP (0.6%)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoSelladoDetalle.toFixed(2)"
                       readonly>
            </div>
        </div>


        <div class="row g-3">
            
            <div class="col-md-6">
                <label class="form-label fw-bold text-primary">Total a Pagar AHORA</label>
                <div class="input-group">
                    <span class="input-group-text bg-primary text-white border-primary">$</span>
                    <input type="text" 
                           class="form-control fw-bold text-primary border-primary bg-white" 
                           :value="totalPagarAhoraDetalle.toFixed(2)" 
                           readonly>
                </div>
                <small class="text-muted fst-italic">Suma: Pago Lote + Honorarios + Sellado</small>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold text-danger">Saldo Lote a Pagar (en 48hs)</label>
                <div class="input-group">
                    <span class="input-group-text bg-danger text-white border-danger">$</span>
                    <input type="text" 
                           class="form-control fw-bold text-danger border-danger bg-white" 
                           :value="saldoRestanteDetalle.toFixed(2)" 
                           readonly>
                </div>
                <small class="text-muted fst-italic">Resto del valor del lote</small>
            </div>

        </div>


<ul class="nav nav-tabs mb-3 mt-4" id="pagoTabsDet" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="gobierno-tab-det" data-bs-toggle="tab" data-bs-target="#gobierno-det" type="button" role="tab">Gob. San Luis</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="cmcpsl-tab-det" data-bs-toggle="tab" data-bs-target="#cmcpsl-det" type="button" role="tab">CMCPSL</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="dpip-tab-det" data-bs-toggle="tab" data-bs-target="#dpip-det" type="button" role="tab">DPIP</button>
    </li>
</ul>


<div class="tab-content" id="pagoTabsContentDet">

    <div class="tab-pane fade show active" id="gobierno-det" role="tabpanel">
        <div class="alert alert-light border p-3">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="small fw-bold">Efectivo</label>
                    <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.gobierno.efectivo" readonly>
                </div>
                <div class="col-6">
                    <label class="small fw-bold">Transferencia</label>
                    <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.gobierno.transferencia" readonly>
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">us Dolares</label>
            <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.gobierno.dolar_monto" readonly>
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.gobierno.dolar_cotizacion" readonly>
                    </div>
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">ðŸ‡ªðŸ‡º Euros</label>
            <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">â‚¬</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.gobierno.euro_monto" placeholder="Monto" readonly>
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.gobierno.euro_cotizacion" placeholder="Valor toma" readonly>
                    </div>
                </div>
            </div>

            </div>
    </div>

    <div class="tab-pane fade" id="cmcpsl-det" role="tabpanel">
        <div class="alert alert-light border p-3">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="small fw-bold">Efectivo</label>
                    <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.cmcpsl.efectivo" readonly>
                </div>
                <div class="col-6">
                    <label class="small fw-bold">Transferencia</label>
                    <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.cmcpsl.transferencia" readonly>
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">us Dolares</label>
             <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.cmcpsl.dolar_monto" readonly>
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.cmcpsl.dolar_cotizacion" readonly>
                    </div>
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">ðŸ‡ªðŸ‡º Euros</label>
            <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">â‚¬</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.cmcpsl.euro_monto" placeholder="Monto" readonly>
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.cmcpsl.euro_cotizacion" placeholder="Valor toma" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="dpip-det" role="tabpanel">
        <div class="alert alert-light border p-3">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="small fw-bold">Efectivo</label>
                    <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.dpip.efectivo" readonly>
                </div>
                <div class="col-6">
                    <label class="small fw-bold">Transferencia</label>
                    <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.dpip.transferencia" readonly>
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">us Dolares</label>
             <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.dpip.dolar_monto" readonly>
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.dpip.dolar_cotizacion" readonly>
                    </div>
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">ðŸ‡ªðŸ‡º Euros</label>
            <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">â‚¬</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.dpip.euro_monto" placeholder="Monto" readonly>
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control form-control-sm bg-white" v-model="pagosDetalle.dpip.euro_cotizacion" placeholder="Valor toma" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


<div class="row">
            
            <div class="col-md-6 mb-3">
                <label for="razon_social" class="form-label">Razon Social</label>
                <input type="text" class="form-control form-control-sm bg-white" id="razon_social" name="razon_social" v-model="reciboADetalle.razon_social" readonly>
            </div>
            <div class="col-md-6 mb-3">
                <label for="apoderado_socio" class="form-label">Apoderado Socio</label>
                <input type="text" class="form-control form-control-sm bg-white" id="apellido" name="apoderado_socio" v-model="reciboADetalle.apoderado_socio" readonly>
            </div>

            <div class="col-md-4 mb-3">
                <label for="tipo" class="form-label">Tipo Dni o Cuil</label>
                <input type="text" class="form-control form-control-sm bg-white" id="tipo" name="tipo" value="Dni" v-model="reciboADetalle.tipo" readonly>
            </div>
            <div class="col-md-8 mb-3">
                <label for="numero" class="form-label">Numero de Dni o Cuit</label>
                <input type="text" class="form-control form-control-sm bg-white" id="numero" name="numero" v-model="reciboADetalle.numero" readonly>
            </div>

            <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control form-control-sm bg-white" id="email" name="email" v-model="reciboADetalle.email" readonly>
            </div>
            <div class="col-md-6 mb-3">
                <label for="telefono" class="form-label">Telefono</label>
                <input type="tel" class="form-control form-control-sm bg-white" id="telefono" name="telefono" v-model="reciboADetalle.telefono" readonly>
            </div>

            <div class="col-12 mb-3">
                <label for="domicilio" class="form-label">Domicilio</label>
                <input type="text" class="form-control form-control-sm bg-white" id="domicilio" name="domicilio" v-model="reciboADetalle.domicilio" readonly>
            </div>

            <div class="col-md-4 mb-3">
                <label for="codigo_postal" class="form-label">C.P.</label>
                <input type="text" class="form-control form-control-sm bg-white" id="codigo_postal" name="codigo_postal" v-model="reciboADetalle.codigo_postal" readonly>
            </div>
            <div class="col-md-8 mb-3">
                <label for="provincia" class="form-label">Provincia</label>
                <input type="text" class="form-control form-control-sm bg-white" id="provincia" name="provincia" v-model="reciboADetalle.provincia" readonly>
            </div>

        </div> 


            </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal modificar-->
<div class="modal fade" id="modificarModal" tabindex="-1" aria-labelledby="modificarModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modificarModalLabel">Modificar Recibo</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form v-on:submit.prevent="modificarRecibo" id="formModificarRecibo" class="needs-validation" novalidate>
        <div class="modal-body" v-if="reciboAModificar">
            <input type="hidden" name="id_recibo_persona_juridica" v-model="reciboAModificar.id_recibo_persona_juridica" />
            <div class="card mb-3 bg-light">
                <div class="card-body">

            <div v-if="reciboAModificar.lote">
                <h2 class="text-secondary">Lote que tiene el Recibo</h2>
                <div class="alert alert-success d-flex justify-content-between align-items-center p-2 mb-2">
                    <div>
                        <strong>Lote NÂ°: {{ reciboAModificar.lote.n_lote }}</strong><br>
                        <small>Base: ${{ reciboAModificar.lote.base }} | Marca: {{ reciboAModificar.lote.marca }}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" v-on:click="limpiarLoteModificar">Cambiar / Quitar</button>
                </div>

                <div class="mb-2">
                    <label for="precio_subastado" class="form-label fw-bold text-primary">Precio Final Subastado</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" 
                               class="form-control fw-bold" 
                               id="precio_subastado" 
                               name="precio_subastado" 
                               v-model="precioSubastadoModificar"
                               step="0.01"
                               required> 
                    </div>
                </div>

                <input type="hidden" name="id_lote" :value="reciboAModificar.lote.id_lote">
            </div>


            <div v-else>
                    <h2 class="text-secondary">Buscar Nuevo Lote</h2>
                    <label class="form-label fw-bold">Ingrese NÂ° de Lote</label>
            
                    <div class="input-group mb-2">
                        <input type="text" 
                               class="form-control" 
                               v-model="busquedaLoteModificar"
                               v-on:keypress.enter.prevent="buscarLoteModificar"
                               ref="inputBusqueda"> <button class="btn btn-primary" 
                                type="button" 
                                v-on:click="buscarLoteModificar" 
                                :disabled="cargando">
                            <span v-if="cargando" class="spinner-border spinner-border-sm"></span>
                            <span v-else>Buscar</span>
                        </button>
                    </div>

                    <div v-if="errorBusquedaModificar" class="text-danger small mb-2">
                        {{ errorBusquedaModificar }}
                    </div>

                    <div v-if="resultadosBusquedaModificar.length > 0" class="list-group mb-3 shadow-sm">
                        <button type="button" 
                                class="list-group-item list-group-item-action list-group-item-primary"
                                v-for="lote in resultadosBusquedaModificar" 
                                :key="lote.id"
                                v-on:click="seleccionarLoteModificar(lote)">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">Lote NÂ° {{ lote.n_lote }}</h5>
                                <small>${{ lote.base }}</small>
                            </div>
                            <small class="text-muted">Marca: {{ lote.marca }}</small>
                        </button>
                    </div>
                    
                    <div v-if="resultadosBusquedaModificar.length === 0 && busquedaLoteModificar !== '' && !cargandoModificar && busquedaRealizada" class="text-muted text-center mt-2">
                        <small>No se encontraron lotes.</small>
                    </div>
                </div>

        </div>
    </div>

    <div class="card bg-light border-0">
        <div class="card-body">
        <h5 class="mb-3 text-secondary"><i class="bi bi-calculator"></i> LiquidaciÃ³n Total</h5>
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <label class="form-label small fw-bold">% Pago Lote</label>
                <div class="input-group input-group-sm">
                    <input type="number" 
                           class="form-control" 
                           id="pago_lote"
                           name="pago_lote"
                           v-model.number="porcentajeLoteModificar" 
                           min="0" max="100">
                    <span class="input-group-text">%</span>
                </div>
            </div>

            <div class="col-md-4">
                <label class="form-label small fw-bold">Pago Lote ($)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoPagoLoteModificar.toFixed(2)" 
                       readonly>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-bold">Honorarios CMCPSL (10%)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoHonorariosModificar.toFixed(2)" 
                       readonly>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-bold">Sellado DPIP (0.6%)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoSelladoModificar.toFixed(2)" 
                       readonly>
            </div>
        </div>


        <div class="row g-3">
            
            <div class="col-md-6">
                <label class="form-label fw-bold text-primary">Total a Pagar AHORA</label>
                <div class="input-group">
                    <span class="input-group-text bg-primary text-white border-primary">$</span>
                    <input type="text" 
                           class="form-control fw-bold text-primary border-primary bg-white" 
                           :value="totalPagarAhoraModificar.toFixed(2)" 
                           readonly>
                </div>
                <small class="text-muted fst-italic">Suma: Pago Lote + Honorarios + Sellado</small>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold text-danger">Saldo Lote a Pagar (en 48hs)</label>
                <div class="input-group">
                    <span class="input-group-text bg-danger text-white border-danger">$</span>
                    <input type="text" 
                           class="form-control fw-bold text-danger border-danger bg-white" 
                           :value="saldoRestanteModificar.toFixed(2)" 
                           readonly>
                </div>
                <small class="text-muted fst-italic">Resto del valor del lote</small>
            </div>

        </div>



                </div>
            </div>
           


<ul class="nav nav-tabs mb-3 mt-4" id="pagoTabsMod" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="gobierno-tab-mod" data-bs-toggle="tab" data-bs-target="#gobierno-mod" type="button" role="tab">Gob. San Luis</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="cmcpsl-tab-mod" data-bs-toggle="tab" data-bs-target="#cmcpsl-mod" type="button" role="tab">CMCPSL</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="dpip-tab-mod" data-bs-toggle="tab" data-bs-target="#dpip-mod" type="button" role="tab">DPIP</button>
    </li>
</ul>

<div class="tab-content" id="pagoTabsContentMod">

    <div class="tab-pane fade show active" id="gobierno-mod" role="tabpanel">
        <div class="alert alert-light border p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-primary m-0">Gobierno (Modificar)</h6>
                <div class="badge p-2 fs-6" :class="faltaGobiernoMod > 0.5 ? 'bg-danger' : (faltaGobiernoMod < -0.5 ? 'bg-warning text-dark' : 'bg-success')">
                    <span v-if="faltaGobiernoMod > 0.5">Falta: ${{ faltaGobiernoMod.toFixed(2) }}</span>
                    <span v-else-if="faltaGobiernoMod < -0.5">Sobran: ${{ Math.abs(faltaGobiernoMod).toFixed(2) }}</span>
                    <span v-else>Completo <i class="bi bi-check-circle"></i></span>
                </div>
            </div>
            <div class="progress mb-3" style="height: 5px;">
                <div class="progress-bar" role="progressbar" 
                     :style="{ width: Math.min((sumaPagosGobiernoMod / (montoPagoLoteModificar || 1)) * 100, 100) + '%' }"
                     :class="faltaDPIPMod > 0.5 ? 'bg-danger' : 'bg-success'"></div>
            </div>
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="small fw-bold">Efectivo</label>
                    <input type="number" step="0.01" class="form-control form-control-sm" v-model="pagosModificar.gobierno.efectivo">
                </div>
                <div class="col-6">
                    <label class="small fw-bold">Transferencia</label>
                    <input type="number" step="0.01" class="form-control form-control-sm" v-model="pagosModificar.gobierno.transferencia">
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">us Dolares</label>
            <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.gobierno.dolar_monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.gobierno.dolar_cotizacion">
                    </div>
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">ðŸ‡ªðŸ‡º Euros</label>
            <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">â‚¬</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.gobierno.euro_monto" placeholder="Monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.gobierno.euro_cotizacion" placeholder="Valor toma">
                    </div>
                </div>
            </div>

            </div>
    </div>

    <div class="tab-pane fade" id="cmcpsl-mod" role="tabpanel">
        <div class="alert alert-light border p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-primary m-0">CMCPSL (Modificar)</h6>
                <div class="badge p-2 fs-6" :class="faltaCMCPSLMod > 0.5 ? 'bg-danger' : (faltaCMCPSLMod < -0.5 ? 'bg-warning text-dark' : 'bg-success')">
                    <span v-if="faltaCMCPSLMod > 0.5">Falta: ${{ faltaCMCPSLMod.toFixed(2) }}</span>
                    <span v-else>Completo</span>
                </div>
            </div>
            <div class="progress mb-3" style="height: 5px;">
                <div class="progress-bar" role="progressbar" 
                     :style="{ width: Math.min((sumaPagosCMCPSLMod / (montoHonorariosModificar || 1)) * 100, 100) + '%' }"
                     :class="faltaDPIPMod > 0.5 ? 'bg-danger' : 'bg-success'"></div>
            </div>
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="small fw-bold">Efectivo</label>
                    <input type="number" step="0.01" class="form-control form-control-sm" v-model="pagosModificar.cmcpsl.efectivo">
                </div>
                <div class="col-6">
                    <label class="small fw-bold">Transferencia</label>
                    <input type="number" step="0.01" class="form-control form-control-sm" v-model="pagosModificar.cmcpsl.transferencia">
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">us Dolares</label>
             <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.cmcpsl.dolar_monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.cmcpsl.dolar_cotizacion">
                    </div>
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">ðŸ‡ªðŸ‡º Euros</label>
            <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">â‚¬</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.cmcpsl.euro_monto" placeholder="Monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.cmcpsl.euro_cotizacion" placeholder="Valor toma">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="dpip-mod" role="tabpanel">
        <div class="alert alert-light border p-3">
             <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-primary m-0">DPIP (Modificar)</h6>
                <div class="badge p-2 fs-6" :class="faltaDPIPMod > 0.5 ? 'bg-danger' : (faltaDPIPMod < -0.5 ? 'bg-warning text-dark' : 'bg-success')">
                    <span v-if="faltaDPIPMod > 0.5">Falta: ${{ faltaDPIPMod.toFixed(2) }}</span>
                    <span v-else>Completo</span>
                </div>
            </div>
            <div class="progress mb-3" style="height: 5px;">
                <div class="progress-bar" role="progressbar" 
                     :style="{ width: Math.min((sumaPagosDPIPMod / (montoSelladoModificar || 1)) * 100, 100) + '%' }"
                     :class="faltaDPIPMod > 0.5 ? 'bg-danger' : 'bg-success'"></div>
            </div>
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="small fw-bold">Efectivo</label>
                    <input type="number" step="0.01" class="form-control form-control-sm" v-model="pagosModificar.dpip.efectivo">
                </div>
                <div class="col-6">
                    <label class="small fw-bold">Transferencia</label>
                    <input type="number" step="0.01" class="form-control form-control-sm" v-model="pagosModificar.dpip.transferencia">
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">us Dolares</label>
             <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.dpip.dolar_monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.dpip.dolar_cotizacion">
                    </div>
                </div>
            </div>
            <label class="form-label small fw-bold mb-1">ðŸ‡ªðŸ‡º Euros</label>
            <div class="row g-2">
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">â‚¬</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.dpip.euro_monto" placeholder="Monto">
                    </div>
                </div>
                <div class="col-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text text-muted">Cotiz.</span>
                        <input type="number" step="0.01" class="form-control" v-model="pagosModificar.dpip.euro_cotizacion" placeholder="Valor toma">
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


<div class="modal-body">
        <div class="row">
            
            <div class="col-md-6 mb-3">
                <label for="razon_social" class="form-label">Razon Social</label>
                <input type="text" class="form-control" id="razon_social" name="razon_social" v-model="reciboAModificar.razon_social" required>
                <div class="invalid-feedback">El Razon Social es obligatorio.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="apoderado_socio" class="form-label">Apoderado Socio</label>
                <input type="text" class="form-control" id="apellido" name="apoderado_socio" v-model="reciboAModificar.apoderado_socio" required>
                <div class="invalid-feedback">El Apoderado Socio es obligatorio.</div>
            </div>

            <div class="col-md-4 mb-3">
                <label for="tipo" class="form-label">Tipo Dni o Cuil</label>
                <input type="text" class="form-control" id="tipo_dni" name="tipo" value="Dni" v-model="reciboAModificar.tipo" required>
                <div class="invalid-feedback">El Tipo Dni o Cuil es obligatorio.</div>
            </div>
            <div class="col-md-8 mb-3">
                <label for="numero" class="form-label">Numero de Dni o Cuit</label>
                <input type="text" class="form-control" id="numero" name="dni" v-model="reciboAModificar.numero" required>
                <div class="invalid-feedback">El Numero de Dni o Cuit es obligatorio.</div>
            </div>

            <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" v-model="reciboAModificar.email" required>
                <div class="invalid-feedback">El Email es obligatorio.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="telefono" class="form-label">Telefono</label>
                <input type="tel" class="form-control" id="telefono" name="telefono" v-model="reciboAModificar.telefono" required>
                <div class="invalid-feedback">El Telefono es obligatorio.</div>
            </div>

            <div class="col-12 mb-3">
                <label for="domicilio" class="form-label">Domicilio</label>
                <input type="text" class="form-control" id="domicilio" name="domicilio" v-model="reciboAModificar.domicilio" required>
                <div class="invalid-feedback">El Domicilio es obligatorio.</div>
            </div>

            <div class="col-md-4 mb-3">
                <label for="codigo_postal" class="form-label">C.P.</label>
                <input type="text" class="form-control" id="codigo_postal" name="codigo_postal" v-model="reciboAModificar.codigo_postal" required>
                <div class="invalid-feedback">El C.P. es obligatorio.</div>
            </div>
            <div class="col-md-8 mb-3">
                <label for="provincia" class="form-label">Provincia</label>
                <input type="text" class="form-control" id="provincia" name="provincia" v-model="reciboAModificar.provincia" required>
                <div class="invalid-feedback">El Provincia es obligatorio.</div>
            </div>

        </div> 
        </div>


        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>


<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Sistema</strong>
      <small class="text-muted">justo ahora</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Cerrar"></button>
    </div>
    <div class="toast-body">
      @TempData["Mensaje"]
    </div>
  </div>
</div>

<!-- Modal eliminar-->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar EliminaciÃ³n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Â¿EstÃ¡s seguro de que deseas eliminar este Recibo?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a id="confirmDeleteButton" href="#" class="btn btn-danger">Eliminar</a>
      </div>
    </div>
  </div>
</div>
@section Scripts {
<script>
    const appConfig = {
        data() {
            return {
                recibos: [],
                paginaActual: 1,
                totalPaginas: 0,
                busquedaLote: '',
                loteSeleccionado: null,
                errorBusqueda: null,
                cargando: false,
                resultadosBusqueda: [],
                textoBusqueda: '',
                timerBusqueda: null,
                //agregar recibo
                pagos: {
                gobierno: { 
                    efectivo: 0, transferencia: 0, 
                    dolar_monto: 0, dolar_cotizacion: 0, 
                    euro_monto: 0, euro_cotizacion: 0 
                },
                cmcpsl: { 
                    efectivo: 0, transferencia: 0, 
                    dolar_monto: 0, dolar_cotizacion: 0, 
                    euro_monto: 0, euro_cotizacion: 0 
                },
                dpip: { 
                    efectivo: 0, transferencia: 0, 
                    dolar_monto: 0, dolar_cotizacion: 0, 
                    euro_monto: 0, euro_cotizacion: 0 
                }
            },
            precioSubastado: 0,
            porcentajeLote: 30,
            modalAgregarBS: null,
            //eliminar recibo
            modalEliminarBS: null,
            reciboAEliminar: null,
            //detalle recibo
            modalDetalleBS: null,
            toastBS: null,
            precioSubastadoDetalle: 0,
            porcentajeLoteDetalle: 30,
            reciboADetalle: null,
            pagosDetalle: {
            gobierno: { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
            cmcpsl:   { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
            dpip:     { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 }
            },
            //modificar recibo
            reciboAModificar: null,
            precioSubastadoModificar: 0,
            porcentajeLoteModificar: 30,
            modalModificarBS: null,
            busquedaLoteModificar: '',
            cargandoModificar: false,
            errorBusquedaModificar: null,
            resultadosBusquedaModificar: [],
            loteSeleccionadoModificar: null,
            pagosModificar: {
            gobierno: { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
            cmcpsl:   { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
            dpip:     { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 }
            }
            };
        },
    mounted() {
            this.cargarRecibo();
            // Inicializar Toast
            const toastEl = document.getElementById('successToast');
            if (toastEl) this.toastBS = new bootstrap.Toast(toastEl);
            
            // Inicializar Modales de Bootstrap para poder abrirlos/cerrarlos desde JS
            this.modalAgregarBS = new bootstrap.Modal(document.getElementById('agregarModal'));
            this.modalEliminarBS = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            this.modalDetalleBS = new bootstrap.Modal(document.getElementById('confirmDetalleModal'));
            this.modalModificarBS = new bootstrap.Modal(document.getElementById('modificarModal'));
        },
    computed: {
        sumaPagosGobiernoMod() {
        const p = this.pagosModificar.gobierno;
        return (parseFloat(p.efectivo)||0) + (parseFloat(p.transferencia)||0) + 
               ((parseFloat(p.dolar_monto)||0) * (parseFloat(p.dolar_cotizacion)||0)) + 
               ((parseFloat(p.euro_monto)||0) * (parseFloat(p.euro_cotizacion)||0));
        },
        faltaGobiernoMod() { return this.montoPagoLoteModificar - this.sumaPagosGobiernoMod; },

        sumaPagosCMCPSLMod() {
            const p = this.pagosModificar.cmcpsl;
            return (parseFloat(p.efectivo)||0) + (parseFloat(p.transferencia)||0) + 
                ((parseFloat(p.dolar_monto)||0) * (parseFloat(p.dolar_cotizacion)||0)) + 
                ((parseFloat(p.euro_monto)||0) * (parseFloat(p.euro_cotizacion)||0));
        },
        faltaCMCPSLMod() { return this.montoHonorariosModificar - this.sumaPagosCMCPSLMod; },

        sumaPagosDPIPMod() {
            const p = this.pagosModificar.dpip;
            return (parseFloat(p.efectivo)||0) + (parseFloat(p.transferencia)||0) + 
                ((parseFloat(p.dolar_monto)||0) * (parseFloat(p.dolar_cotizacion)||0)) + 
                ((parseFloat(p.euro_monto)||0) * (parseFloat(p.euro_cotizacion)||0));
        },
        faltaDPIPMod() { return this.montoSelladoModificar - this.sumaPagosDPIPMod; },
        montoPagoLoteModificar() {
            let precio = parseFloat(this.precioSubastadoModificar) || 0;
            let porcentaje = parseFloat(this.porcentajeLoteModificar) || 0;
            return precio * (porcentaje / 100);
        },
        montoHonorariosModificar() {
            let precio = parseFloat(this.precioSubastadoModificar) || 0;
            return precio * 0.10;
        },
        // 3. Calcula el 0.6% fijo de Sellado
        montoSelladoModificar() {
            let precio = parseFloat(this.precioSubastadoModificar) || 0;
            return precio * 0.006;
        },
        totalPagarAhoraModificar() {
            return this.montoPagoLoteModificar + this.montoHonorariosModificar + this.montoSelladoModificar;
        },
        // 5. Calcula lo que falta pagar del lote (Total - lo que pagÃ³ del lote)
        saldoRestanteModificar() {
            let precio = parseFloat(this.precioSubastadoModificar) || 0;
            return precio - this.montoPagoLoteModificar;
        },
        montoPagoLoteDetalle() {
            let precio = parseFloat(this.precioSubastadoDetalle) || 0;
            let porcentaje = parseFloat(this.porcentajeLoteDetalle) || 0;
            return precio * (porcentaje / 100);
        },
        montoHonorariosDetalle() {
            let precio = parseFloat(this.precioSubastadoDetalle) || 0;
            return precio * 0.10;
        },
        montoSelladoDetalle() {
            let precio = parseFloat(this.precioSubastadoDetalle) || 0;
            return precio * 0.006;
        },
        totalPagarAhoraDetalle() {
            return this.montoPagoLoteDetalle + this.montoHonorariosDetalle + this.montoSelladoDetalle;
        },
        saldoRestanteDetalle() {
            let precio = parseFloat(this.precioSubastadoDetalle) || 0;
            return precio - this.montoPagoLoteDetalle;
        },
       montoPagoLote() {
            let precio = parseFloat(this.precioSubastado) || 0;
            let porcentaje = parseFloat(this.porcentajeLote) || 0;
            return precio * (porcentaje / 100);
        },
        // 2. Calcula el 10% fijo de Honorarios
        montoHonorarios() {
            let precio = parseFloat(this.precioSubastado) || 0;
            return precio * 0.10;
        },
        // 3. Calcula el 0.6% fijo de Sellado
        montoSellado() {
            let precio = parseFloat(this.precioSubastado) || 0;
            return precio * 0.006;
        },// 4. Suma los tres anteriores para el total que debe poner la persona YA
        totalPagarAhora() {
            return this.montoPagoLote + this.montoHonorarios + this.montoSellado;
        },
        // 5. Calcula lo que falta pagar del lote (Total - lo que pagÃ³ del lote)
        saldoRestante() {
            let precio = parseFloat(this.precioSubastado) || 0;
            return precio - this.montoPagoLote;
        },
        sumaPagosGobierno() {
            const p = this.pagos.gobierno;
            const efectivo = parseFloat(p.efectivo) || 0;
            const transf = parseFloat(p.transferencia) || 0;
            const dolar = (parseFloat(p.dolar_monto) || 0) * (parseFloat(p.dolar_cotizacion) || 0);
            const euro = (parseFloat(p.euro_monto) || 0) * (parseFloat(p.euro_cotizacion) || 0);
            return efectivo + transf + dolar + euro;
        },
        faltaGobierno() {
            return this.montoPagoLote - this.sumaPagosGobierno;
        },
        sumaPagosCMCPSL() {
            const p = this.pagos.cmcpsl;
            const efectivo = parseFloat(p.efectivo) || 0;
            const transf = parseFloat(p.transferencia) || 0;
            const dolar = (parseFloat(p.dolar_monto) || 0) * (parseFloat(p.dolar_cotizacion) || 0);
            const euro = (parseFloat(p.euro_monto) || 0) * (parseFloat(p.euro_cotizacion) || 0);
            return efectivo + transf + dolar + euro;
        },
        faltaCMCPSL() {
            return this.montoHonorarios - this.sumaPagosCMCPSL;
        },
        sumaPagosDPIP() {
            const p = this.pagos.dpip;
            const efectivo = parseFloat(p.efectivo) || 0;
            const transf = parseFloat(p.transferencia) || 0;
            const dolar = (parseFloat(p.dolar_monto) || 0) * (parseFloat(p.dolar_cotizacion) || 0);
            const euro = (parseFloat(p.euro_monto) || 0) * (parseFloat(p.euro_cotizacion) || 0);
            return efectivo + transf + dolar + euro;
        },
        faltaDPIP() {
            return this.montoSellado - this.sumaPagosDPIP;
        }
        },
    methods: {
    imprimirRecibo(recibo) {
            //calcular pago lote
            let precio = parseFloat(recibo.precio_subastado) || 0;
            let porcentaje = parseFloat(recibo.pago_lote) || 0;
            recibo.pago_lotee =  precio * (porcentaje / 100);
            //calcular honorarios
            recibo.honorarios = precio * 0.10;
            //caclular sellado
            recibo.sellado =  precio * 0.006;

                const contenidoHtml = `
                    <div id="impresion-recibo">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h2 style="margin: 0;">RECIBO DE SUBASTA</h2>
                            <p style="margin: 5px 0;">Comprobante oficial de adjudicaciÃ³n</p>
                            <hr>
                        </div>
                        <h3 style="font-family: sans-serif; color: #2c3e50; border-bottom: 1px solid #eee;">Datos del Recibo</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-family: sans-serif;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">% Pago Lote</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Pago Lote ($)</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Honorarios CMCPSL (10%)</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Sellado DPIP (0.6%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">% ${recibo.pago_lote}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">$ ${recibo.pago_lotee}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">$ ${recibo.honorarios}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">$ ${recibo.sellado}</td>
                                </tr>
                            </tbody>
                        </table>
                        <h3 style="font-family: sans-serif; color: #2c3e50; border-bottom: 1px solid #eee;">Datos del Comprador</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-family: sans-serif;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Razon Social</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Apoderado Socio</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Provincia</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">${recibo.tipo}</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Telefono</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Codigo Postal</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Email</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Domicilio</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.razon_social}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.apoderado_socio}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.provincia}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.numero}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.telefono}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.codigo_postal}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.email}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.domicilio}</td>
                                </tr>
                            </tbody>
                        </table>

                        <h3 style="font-family: sans-serif; color: #2c3e50; border-bottom: 1px solid #eee;">Detalle del Lote</h3>
                        <table style="width: 100%; border-collapse: collapse; font-family: sans-serif;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">NÂ° Lote</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Marca</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Modelo</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Dominio</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">AÃ±o</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Base</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Precio Subastado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.lote.n_lote}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.lote.marca}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.lote.modelo}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.lote.dominio}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${recibo.lote.anio}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">$ ${recibo.lote.base}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">$ ${recibo.precio_subastado}</td>
                                </tr>
                            </tbody>
                        </table>
                        <h3 style="font-family: sans-serif; color: #2c3e50; border-bottom: 1px solid #eee;">Formas de Pago</h3>
                        <table style="width: 100%; border-collapse: collapse; font-family: sans-serif; margin-top: 10px;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Destinatario</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Efectivo</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Transferencia</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">DÃ³lares (Monto / Cot.)</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Euros (Monto / Cot.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recibo.formasDePago.map(pago => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${pago.destinatario}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">
                                        $ ${pago.efectivo}
                                    </td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">
                                        $ ${pago.transferencia}
                                    </td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">
                                        ${pago.dolar_monto > 0 
                                            ? `US$ ${pago.dolar_monto} (x ${pago.dolar_cotizacion})` 
                                            : '-'}
                                    </td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">
                                        ${pago.euro_monto > 0 
                                            ? `â‚¬ ${pago.euro_monto} (x ${pago.euro_cotizacion})` 
                                            : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                        <div style="margin-top: 30px; text-align: center; font-family: sans-serif;">
                            <p><strong>Firma y Sello</strong></p>
                            <br><br>
                            <p>_______________________</p>
                        </div>
                    </div>
                `;

                // 2. Ejecutamos Print.js con el HTML crudo
                printJS({
                    printable: contenidoHtml,
                    type: 'raw-html',
                    scanStyles: false // Para que use los estilos inline que pusimos arriba
                });
            },
    async modificarRecibo() {
            const form = document.getElementById('formModificarRecibo');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            form.classList.add('was-validated');
            const formData = new FormData(form);
            const datosPersonales = Object.fromEntries(formData.entries());
            const listaPagosArray = [];
            const limpiarNumero = (val) => parseFloat(val) || 0;
            if (this.pagosModificar.gobierno) {
                listaPagosArray.push({
                destinatario: "Gobierno", // Agregamos el nombre manualmente
                efectivo: limpiarNumero(this.pagosModificar.gobierno.efectivo),
                transferencia: limpiarNumero(this.pagosModificar.gobierno.transferencia),
                dolar_monto: limpiarNumero(this.pagosModificar.gobierno.dolar_monto),
                dolar_cotizacion: limpiarNumero(this.pagosModificar.gobierno.dolar_cotizacion),
                euro_monto: limpiarNumero(this.pagosModificar.gobierno.euro_monto),
                euro_cotizacion: limpiarNumero(this.pagosModificar.gobierno.euro_cotizacion)
            });
        }

        // B. Procesar CMCPSL
        if (this.pagosModificar.cmcpsl) {
            listaPagosArray.push({
                destinatario: "Cmcpsl",
                efectivo: limpiarNumero(this.pagosModificar.cmcpsl.efectivo),
                transferencia: limpiarNumero(this.pagosModificar.cmcpsl.transferencia),
                dolar_monto: limpiarNumero(this.pagosModificar.cmcpsl.dolar_monto),
                dolar_cotizacion: limpiarNumero(this.pagosModificar.cmcpsl.dolar_cotizacion),
                euro_monto: limpiarNumero(this.pagosModificar.cmcpsl.euro_monto),
                euro_cotizacion: limpiarNumero(this.pagosModificar.cmcpsl.euro_cotizacion)
            });
        }

        // C. Procesar DPIP
        if (this.pagosModificar.dpip) {
            listaPagosArray.push({
                destinatario: "Dpip",
                efectivo: limpiarNumero(this.pagosModificar.dpip.efectivo),
                transferencia: limpiarNumero(this.pagosModificar.dpip.transferencia),
                dolar_monto: limpiarNumero(this.pagosModificar.dpip.dolar_monto),
                dolar_cotizacion: limpiarNumero(this.pagosModificar.dpip.dolar_cotizacion),
                euro_monto: limpiarNumero(this.pagosModificar.dpip.euro_monto),
                euro_cotizacion: limpiarNumero(this.pagosModificar.dpip.euro_cotizacion)
            });
        }
        const TOLERANCIA = 1.00;
        if (this.faltaCMCPSLMod > TOLERANCIA) {
            this.mostrarToast(`Error: Falta completar el pago a CMCPSL. Restan: $${this.faltaCMCPSL.toFixed(2)}`);
            console.warn("Bloqueado por falta de pago CMCPSL");
            return;
        }
        if (this.faltaCMCPSLMod < -TOLERANCIA) {
            this.mostrarToast(`Error: El pago a CMCPSL excede lo requerido. Sobran: $${Math.abs(this.faltaCMCPSLMod).toFixed(2)}`);
            this.modalModificarBS.hide();
            return;
        }

        // 2. Validar DPIP
        if (this.faltaDPIPMod > TOLERANCIA) {
            this.mostrarToast(`Error: Falta completar el pago a DPIP. Restan: $${this.faltaDPIP.toFixed(2)}`);
            console.warn("Bloqueado por falta de pago DPIP");
            return;
        }
        if (this.faltaDPIPMod < -TOLERANCIA) {
            this.mostrarToast(`Error: El pago a DPIP excede lo requerido. Sobran: $${Math.abs(this.faltaDPIPMod).toFixed(2)}`);
            this.modalModificarBS.hide();
            return;
        }

        // 3. Validar Gobierno
        if (this.faltaGobiernoMod > TOLERANCIA) {
            this.mostrarToast(`Error: Falta completar el pago al Gobierno. Restan: $${this.faltaGobierno.toFixed(2)}`);
            console.warn("Bloqueado por falta de pago Gobierno");
            return;
        }
        if (this.faltaGobiernoMod < -TOLERANCIA) {
            this.mostrarToast(`Error: El pago al Gobierno excede lo requerido. Sobran: $${Math.abs(this.faltaGobiernoMod).toFixed(2)}`);
            this.modalModificarBS.hide();
            return;
        }
        if(this.reciboAModificar.lote == null){
            this.mostrarToast(`Error: No hay lote en el recibo`);
            this.modalModificarBS.hide();
            return;
        }

    const payload = {
        // Datos de la persona (spread operator para sacar lo del form)
        razon_social: datosPersonales.razon_social,
        apoderado_socio: datosPersonales.apoderado_socio,
        numero: datosPersonales.numero,
        tipo: datosPersonales.tipo,
        email: datosPersonales.email,
        telefono: datosPersonales.telefono,
        domicilio: datosPersonales.domicilio,
        codigo_postal: datosPersonales.codigo_postal,
        provincia: datosPersonales.provincia,
        pago_lote: datosPersonales.pago_lote,

        // Datos del recibo y lote
        id_lote: this.loteSeleccionadoModificar?.id_lote || datosPersonales.id_lote,
        precio_subastado: parseFloat(this.datosPersonales?.precio_subastado || this.precioSubastadoModificar),
        id_recibo_persona_juridica: datosPersonales.id_recibo_persona_juridica,
        n_lote: this.reciboAModificar.lote.n_lote,

        lista_pagos: listaPagosArray
    };
            console.log("Modificando recibo:", payload);
            
                try {
                // 2. Enviar la peticiÃ³n a la API
                const response = await fetch(`/api/recibosjmd`, {
                    method: 'PUT',
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                    
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.mensaje || 'Error al modificar el Recibo.');
                }

                
                this.modalModificarBS.hide();
                form.reset();
                this.mostrarToast("Recibo modificado exitosamente");
                this.cargarRecibo();
                
            } catch (error) {
                console.error('Error al modificar Recibo:', error);
                this.modalModificarBS.hide();
                this.mostrarToast(error.message); 
            }
            
            
        },
        mostrarModalModificar(recibo) {
                console.log(recibo);
                this.reciboAModificar = JSON.parse(JSON.stringify(recibo));
                this.precioSubastadoModificar = recibo.precio_subastado;
                this.porcentajeLoteModificar = recibo.pago_lote;
                this.pagosModificar = {
                    gobierno: { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
                    cmcpsl:   { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
                    dpip:     { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 }
                };
                if (recibo.formasDePago && Array.isArray(recibo.formasDePago)) {
                    recibo.formasDePago.forEach(pago => {
                    let entidad = '';
                    if (pago.destinatario === 'Gobierno') entidad = 'gobierno';
                    else if (pago.destinatario === 'Cmcpsl') entidad = 'cmcpsl';
                    else if (pago.destinatario === 'Dpip') entidad = 'dpip';

                    if (entidad) {
                        this.pagosModificar[entidad] = {
                            efectivo: pago.efectivo,
                            transferencia: pago.transferencia,
                            dolar_monto: pago.dolar_monto,
                            dolar_cotizacion: pago.dolar_cotizacion,
                            euro_monto: pago.euro_monto,
                            euro_cotizacion: pago.euro_cotizacion
                        };
                    }
                });
            }
            this.$nextTick(() => {
                if (this.modalModificarBS) {
                        this.modalModificarBS.show();
                }
            });
                
        },
        async buscarLoteModificar() {
            if (!this.busquedaLoteModificar) return;
            
            this.cargandoModificar = true;
            this.errorBusquedaModificar = null;
            this.resultadosBusquedaModificar = []; 
            this.loteSeleccionadoModificar = null; 

            try {
                
                const response = await fetch(`/api/buscar/lotes/${encodeURIComponent(this.busquedaLoteModificar)}`);

                if (response.ok) {
                    const data = await response.json();
                    
                    
                    if (Array.isArray(data)) {
                        this.resultadosBusquedaModificar = data;
                        
                        if (data.length === 0) {
                            this.errorBusquedaModificar = "No se encontraron coincidencias.";
                        }
                    } else {
                        this.resultadosBusquedaModificar = [data];
                    }

                } else {
                    if (response.status === 404) {
                        this.errorBusquedaModificar = "No se encontrÃ³ un lote con ese nÃºmero.";
                    } else {
                        this.errorBusquedaModificar = "Error al buscar el lote.";
                    }
                }
            } catch (error) {
                console.error(error);
                this.errorBusquedaModificar = "Error de conexiÃ³n con el servidor.";
            } finally {
                this.cargandoModificar = false;
            }
        },
        limpiarLoteModificar() {
            this.reciboAModificar.lote = null;
            //this.reciboAModificar.id_lote = null;
            this.busquedaLoteModificar = '';
            this.resultadosBusquedaModificar = [];
        },
        seleccionarLoteModificar(lote) {
            this.reciboAModificar.lote = lote; 
            this.resultadosBusquedaModificar = [];
            this.busquedaLoteModificar = '';
        },
        mostrarModalDetalle(recibo){
                this.reciboADetalle = recibo;
                this.precioSubastadoDetalle = recibo.precio_subastado;
                this.porcentajeLoteDetalle = recibo.pago_lote;
                this.pagosDetalle = {
                    gobierno: { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
                    cmcpsl:   { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
                    dpip:     { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 }
                };
                if (recibo.formasDePago && Array.isArray(recibo.formasDePago)) {
                    recibo.formasDePago.forEach(pago => {
                    let entidad = '';
                    if (pago.destinatario === 'Gobierno') entidad = 'gobierno';
                    else if (pago.destinatario === 'Cmcpsl') entidad = 'cmcpsl';
                    else if (pago.destinatario === 'Dpip') entidad = 'dpip';

                    if (entidad) {
                        this.pagosDetalle[entidad] = {
                            efectivo: pago.efectivo,
                            transferencia: pago.transferencia,
                            dolar_monto: pago.dolar_monto,
                            dolar_cotizacion: pago.dolar_cotizacion,
                            euro_monto: pago.euro_monto,
                            euro_cotizacion: pago.euro_cotizacion
                        };
                    }
                });
                }
                console.log(recibo);
                this.modalDetalleBS.show();
            },
        seleccionarLote(lote) {
                    this.loteSeleccionado = lote;      
                    this.busquedaLote = lote.numero;   
                    this.resultadosBusqueda = [];      
                    
                    console.log("Lote seleccionado:", this.loteSeleccionado);
                    
        },
        limpiarLote() {
            this.loteSeleccionado = null;
            this.busquedaLote = '';
            this.errorBusqueda = null;
            this.precioSubastado = 0
            this.porcentajeLote = 30;
            this.resetearFormasPago();
        },
        buscarConRetraso() {
                if (this.timerBusqueda) clearTimeout(this.timerBusqueda);
                
                this.timerBusqueda = setTimeout(() => {
                    this.paginaActual = 1; 
                    this.cargarRecibo();
                }, 500); 
            },
        cambiarPagina(nuevaPagina) {
            if (nuevaPagina >= 1 && nuevaPagina <= this.totalPaginas) {
                this.paginaActual = nuevaPagina;
                this.cargarRecibo();
            }
        },
        // --- Utilidades ---
        formatearFecha(fechaISO) {
            if (!fechaISO) return '';
            return new Date(fechaISO).toLocaleDateString('es-ES');
        },
        async cargarRecibo() {
                try {
                    
                    let url = `/api/reciboj?pagina=${this.paginaActual}`;
                    if (this.textoBusqueda) {
                        const valor = this.textoBusqueda.trim();

                        if (!isNaN(valor) && valor !== "") {
                            url += `&numeroLote=${encodeURIComponent(valor)}`;
                        } else {
                            url += `&razonSocial=${encodeURIComponent(valor)}`;
                        }
                    }
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Error al cargar los recibos');
                    const data = await response.json();
                    
                    this.recibos = data.recibos; 
                    this.totalPaginas = data.totalPaginas;
                    this.paginaActual = data.paginaActual;
                } catch (error) {
                    console.error('Error:', error);
                }
            },
            async buscarLote() {
                    if (!this.busquedaLote) return;
                    
                    this.cargando = true;
                    this.errorBusqueda = null;
                    this.resultadosBusqueda = []; 
                    this.loteSeleccionado = null; 

                    try {
                        
                        const response = await fetch(`/api/buscar/lotes/${encodeURIComponent(this.busquedaLote)}`);

                        if (response.ok) {
                            const data = await response.json();
                            
                            if (Array.isArray(data)) {
                                this.resultadosBusqueda = data;
                                
                                if (data.length === 0) {
                                    this.errorBusqueda = "No se encontraron coincidencias.";
                                }
                            } else {
                                this.resultadosBusqueda = [data];
                            }

                        } else {
                            if (response.status === 404) {
                                this.errorBusqueda = "No se encontrÃ³ un lote con ese nÃºmero.";
                            } else {
                                this.errorBusqueda = "Error al buscar el lote.";
                            }
                        }
                    } catch (error) {
                        console.error(error);
                        this.errorBusqueda = "Error de conexiÃ³n con el servidor.";
                    } finally {
                        this.cargando = false;
                    }
                },
                resetearFormasPago() {
                    this.pagos = {
                        gobierno: { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
                        cmcpsl:   { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
                        dpip:     { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 }
                    };
                },
            async crearRecibo() {
                    if (!this.loteSeleccionado) {
                        alert("Por favor, busca y selecciona un lote antes de guardar.");
                        return;
                    }
                    const form = document.getElementById('formAgregarRecibo');
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }
                    form.classList.add('was-validated');
                    const formData = new FormData(form);
                    const datosPersonales = Object.fromEntries(formData.entries());
                    const listaPagosArray = [];
                    const limpiarNumero = (val) => parseFloat(val) || 0;
                    if (this.pagos.gobierno) {
                            listaPagosArray.push({
                            destinatario: "Gobierno", // Agregamos el nombre manualmente
                            efectivo: limpiarNumero(this.pagos.gobierno.efectivo),
                            transferencia: limpiarNumero(this.pagos.gobierno.transferencia),
                            dolar_monto: limpiarNumero(this.pagos.gobierno.dolar_monto),
                            dolar_cotizacion: limpiarNumero(this.pagos.gobierno.dolar_cotizacion),
                            euro_monto: limpiarNumero(this.pagos.gobierno.euro_monto),
                            euro_cotizacion: limpiarNumero(this.pagos.gobierno.euro_cotizacion)
                        });
                    }

                    // B. Procesar CMCPSL
                    if (this.pagos.cmcpsl) {
                        listaPagosArray.push({
                            destinatario: "Cmcpsl",
                            efectivo: limpiarNumero(this.pagos.cmcpsl.efectivo),
                            transferencia: limpiarNumero(this.pagos.cmcpsl.transferencia),
                            dolar_monto: limpiarNumero(this.pagos.cmcpsl.dolar_monto),
                            dolar_cotizacion: limpiarNumero(this.pagos.cmcpsl.dolar_cotizacion),
                            euro_monto: limpiarNumero(this.pagos.cmcpsl.euro_monto),
                            euro_cotizacion: limpiarNumero(this.pagos.cmcpsl.euro_cotizacion)
                        });
                    }

                    // C. Procesar DPIP
                    if (this.pagos.dpip) {
                        listaPagosArray.push({
                            destinatario: "Dpip",
                            efectivo: limpiarNumero(this.pagos.dpip.efectivo),
                            transferencia: limpiarNumero(this.pagos.dpip.transferencia),
                            dolar_monto: limpiarNumero(this.pagos.dpip.dolar_monto),
                            dolar_cotizacion: limpiarNumero(this.pagos.dpip.dolar_cotizacion),
                            euro_monto: limpiarNumero(this.pagos.dpip.euro_monto),
                            euro_cotizacion: limpiarNumero(this.pagos.dpip.euro_cotizacion)
                        });
                    }

                    const TOLERANCIA = 1.00;
                    if (this.faltaCMCPSL > TOLERANCIA) {
                        this.mostrarToast(`Error: Falta completar el pago a CMCPSL. Restan: $${this.faltaCMCPSL.toFixed(2)}`);
                        console.warn("Bloqueado por falta de pago CMCPSL");
                        return;
                    }
                    if (this.faltaCMCPSL < -TOLERANCIA) {
                        this.mostrarToast(`Error: El pago a CMCPSL excede lo requerido. Sobran: $${Math.abs(this.faltaCMCPSL).toFixed(2)}`);
                        this.modalAgregarBS.hide();
                        return;
                    }

                    // 2. Validar DPIP
                    if (this.faltaDPIP > TOLERANCIA) {
                        this.mostrarToast(`Error: Falta completar el pago a DPIP. Restan: $${this.faltaDPIP.toFixed(2)}`);
                        console.warn("Bloqueado por falta de pago DPIP");
                        return;
                    }
                    if (this.faltaDPIP < -TOLERANCIA) {
                        this.mostrarToast(`Error: El pago a DPIP excede lo requerido. Sobran: $${Math.abs(this.faltaDPIP).toFixed(2)}`);
                        this.modalAgregarBS.hide();
                        return;
                    }

                    // 3. Validar Gobierno
                    if (this.faltaGobierno > TOLERANCIA) {
                        this.mostrarToast(`Error: Falta completar el pago al Gobierno. Restan: $${this.faltaGobierno.toFixed(2)}`);
                        console.warn("Bloqueado por falta de pago Gobierno");
                        return;
                    }
                    if (this.faltaGobierno < -TOLERANCIA) {
                        this.mostrarToast(`Error: El pago al Gobierno excede lo requerido. Sobran: $${Math.abs(this.faltaGobierno).toFixed(2)}`);
                        this.modalAgregarBS.hide();
                        return;
                    }
                    
                    const payload = {
                // Datos de la persona (spread operator para sacar lo del form)
                razon_social: datosPersonales.razon_social,
                apoderado_socio: datosPersonales.apoderado_socio,
                numero: datosPersonales.numero,
                tipo: datosPersonales.tipo,
                email: datosPersonales.email,
                telefono: datosPersonales.telefono,
                domicilio: datosPersonales.domicilio,
                codigo_postal: datosPersonales.codigo_postal,
                provincia: datosPersonales.provincia,
                pago_lote: datosPersonales.pago_lote,

                // Datos del recibo y lote
                id_lote: this.loteSeleccionado.id_lote,
                precio_subastado: parseFloat(this.precioSubastado),
                n_lote: this.loteSeleccionado.n_lote,
                
                lista_pagos: listaPagosArray
            };

            console.log("Enviando JSON:", payload);
                    try {
                        
                        const response = await fetch('/api/recibosj', {
                            method: 'POST',
                            headers: {
                            'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            // Si la API devuelve un error (ej. 400, 500)
                            throw new Error(data.mensaje || 'Error al procesar la solicitud.');
                        }

                        // Â¡Ã‰xito!
                        this.modalAgregarBS.hide();
                        form.reset();
                        this.limpiarLote();
                        this.mostrarToast(data.mensaje); // Mostramos el toast de Ã©xito
                        this.cargarRecibo();

                    } catch (error) {
                        console.error('Error al crear Recibo:', error);
                        this.modalAgregarBS.hide();
                        this.mostrarToast(error.message);
                    }
            },
            mostrarToast(mensaje) {
                const toastBody = document.querySelector('#successToast .toast-body');
                if(toastBody) toastBody.textContent = mensaje;
                if(this.toastBS) this.toastBS.show();
            },
            mostrarModalEliminar(recibo) {
                this.reciboAEliminar = recibo;
                this.modalEliminarBS.show();
                console.log(recibo);
                // Configurar el botÃ³n "Eliminar" del modal (si no usas click directo en el botÃ³n)
                const btnEliminar = document.getElementById('confirmDeleteButton');
                btnEliminar.onclick = () => this.eliminarReciboConfirmado();
            },
            async eliminarReciboConfirmado() {
                if (!this.reciboAEliminar) return;

                try {
                    const response = await fetch(`/api/recibosj/${this.reciboAEliminar.id_recibo_persona_juridica}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) throw new Error('No se pudo eliminar el recibo.');
                    
                    const data = await response.json();
                    
                    this.modalEliminarBS.hide();
                    this.mostrarToast("recibo eliminado");
                    this.paginaActual = 1;
                    await this.cargarRecibo();
                } catch (error) {
                    console.error('Error al eliminar:', error);
                }
        }

         }
           
    };

    const app = Vue.createApp(appConfig);
    window.appInstance = app.mount('#app');

</script>
<script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
}
