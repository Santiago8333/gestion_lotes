@{
    ViewData["Title"] = "Recibo Persona Juridica";
}
<link rel="stylesheet" href="https://printjs-4de6.kxcdn.com/print.min.css">
<div id="app" class="container mt-5" style="padding-top: 10px;">
    <div class="row">
        <div class="col-md-12 history bg-light border-right">
            <h1>Recibo Persona Juridica</h1>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="busqueda" class="form-label">Buscar Recibos</label>
                    <input 
                        type="text" 
                        id="busqueda"
                        class="form-control" 
                        placeholder="Escribe un apellido o número de lote..."
                        v-model="textoBusqueda"
                        v-on:input="buscarConRetraso"
                        >
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Razon Social</th>
                            <th scope="col">Apoderado Socio</th>
                            <th scope="col">Tipo</th>
                            <th scope="col">Numero</th>
                            <th scope="col">Telefono</th>
                            <th scope="col">Codigo Postal</th>
                            <th scope="col">Email</th>
                            <th scope="col">Domicilio</th>
                            <th scope="col">Provincia</th>
                            <th scope="col">Precio Subastado</th>
                            <th scope="col">Fecha de Creación</th>
                            @if (User.IsInRole("Administrador"))
                            {
                            <th scope="col">Creado Por</th>
                            }
                            <th scope="col">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(recibo, index) in recibos" :key="recibo.id_recibo_persona_juridica">
                            <td>{{ recibo.index }}</td>
                            <td>{{ recibo.razon_social }}</td>
                            <td>{{ recibo.apoderado_socio }}</td>
                            <td>{{ recibo.tipo }}</td>
                            <td>{{ recibo.numero }}</td>
                            <td>{{ recibo.telefono }}</td>
                            <td>{{ recibo.codigo_postal }}</td>
                            <td>{{ recibo.email }}</td>
                            <td>{{ recibo.domicilio }}</td>
                            <td>{{ recibo.provincia }}</td>
                            <td>{{ recibo.precio_subastado }}</td>
                            <td>{{ formatearFecha(recibo.fecha_creacion) }}</td>
                            @if (User.IsInRole("Administrador"))
                            {
                                <td>{{ recibo.creado_por }}</td>
                            }
                            <td>
                                <div class="dropdown position-static">
                                    <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item"  href="javascript:void(0);" v-on:click="">
                                                <i class="fa-solid fa-pencil"></i> Modificar
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item"  href="javascript:void(0);" v-on:click="">
                                                <i class="fa-solid fa-book"></i> Detalle
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0);" class="dropdown-item" v-on:click="">
                                                <i class="fa-solid fa-print"></i> Imprimir
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0);" class="dropdown-item" v-on:click="">
                                                <i class="fa-solid fa-trash"></i> Eliminar
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr v-if="recibos.length === 0">
                            <td colspan="13" class="text-center text-muted">No hay recibos cargados</td>
                        </tr>
                    </tbody>
                </table>
            </div>
             <button type="button" class="btn btn-primary agregar" data-bs-toggle="modal" data-bs-target="#agregarModal"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <nav aria-label="Page navigation" v-if="totalPaginas > 1">
        <ul class="pagination justify-content-center">
            <li class="page-item" :class="{ disabled: paginaActual === 1 }">
                <a class="page-link" href="#" v-on:click.prevent="cambiarPagina(paginaActual - 1)">Anterior</a>
            </li>
            <li class="page-item" v-for="pagina in totalPaginas" :key="pagina" :class="{ active: pagina === paginaActual }">
                <a class="page-link" href="#" v-on:click.prevent="cambiarPagina(pagina)">{{ pagina }}</a>
            </li>
            <li class="page-item" :class="{ disabled: paginaActual === totalPaginas }">
                <a class="page-link" href="#" v-on:click.prevent="cambiarPagina(paginaActual + 1)">Siguiente</a>
            </li>
        </ul>
    </nav>
<!-- Modal Agergar-->
<div class="modal fade" id="agregarModal" tabindex="-1" aria-labelledby="agregarModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="agregarModalLabel">Agregar Recibo</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
  <form  id="formAgregarRecibo" class="needs-validation" novalidate>
    @Html.AntiForgeryToken()
    
    <div class="card mb-3 bg-light">
        <div class="card-body">
            <label class="form-label fw-bold">Buscar Lote</label>
            
            <div class="input-group mb-2">
                <input type="text" 
                       class="form-control" 
                       v-model="busquedaLote" 
                       placeholder="Ingrese N° de Lote"
                       v-on:keypress.enter.prevent="buscarLote"> 
                
                <button class="btn btn-primary" 
                        type="button" 
                        v-on:click="buscarLote" 
                        :disabled="cargando">
                    <span v-if="cargando" class="spinner-border spinner-border-sm"></span>
                    <span v-else>Buscar</span>
                </button>
                
            </div>

            <div v-if="errorBusqueda" class="text-danger small mb-2">
                {{ errorBusqueda }}
            </div>
            <div v-if="resultadosBusqueda.length > 0" class="list-group mb-3 shadow-sm">
                    <button type="button" 
                            class="list-group-item list-group-item-action"
                            v-for="lote in resultadosBusqueda" 
                            :key="lote.id"
                            v-on:click="seleccionarLote(lote)">
                        <strong>Lote N° {{ lote.n_lote }}</strong> 
                        <small class="text-muted">- Precio Base: {{ lote.base }} | Marca: {{ lote.marca }}</small>
                    </button>
                </div>
            <div v-if="loteSeleccionado">
                <div class="alert alert-success d-flex justify-content-between align-items-center p-2 mb-2">
                    <div>
                        <strong>Lote N°: {{ loteSeleccionado.n_lote }}</strong><br>
                        <small>Base: ${{ loteSeleccionado.base }} | Marca: {{ loteSeleccionado.marca }}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" v-on:click="limpiarLote">X</button>
                </div>

                <div class="mb-2">
                    <label for="precio_subastado" class="form-label fw-bold text-primary">Precio Final Subastado</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" 
                               class="form-control fw-bold" 
                               id="precio_subastado" 
                               name="precio_subastado" 
                               v-model="precioSubastado"
                               step="0.01"
                               required> 
                        <div class="invalid-feedback">El Precio Final Subastado es obligatorio.</div>
                    </div>
                </div>

                <input type="hidden" name="id_lote" :value="loteSeleccionado.id_lote">
            </div>
        </div>
    </div>

<h5 class="mb-3 text-secondary"><i class="bi bi-calculator"></i> Liquidación Total</h5>

<div class="card bg-light border-0">
    <div class="card-body">
        
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <label class="form-label small fw-bold">% Pago Lote</label>
                <div class="input-group input-group-sm">
                    <input type="number" 
                           class="form-control" 
                           id="pago_lote"
                           name="pago_lote"
                           v-model.number="porcentajeLote" 
                           min="0" max="100">
                    <span class="input-group-text">%</span>
                </div>
            </div>

            <div class="col-md-4">
                <label class="form-label small fw-bold">Pago Lote ($)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoPagoLote.toFixed(2)" 
                       readonly>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-bold">Honorarios CMCPSL (10%)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoHonorarios.toFixed(2)" 
                       readonly>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-bold">Sellado DPIP (0.6%)</label>
                <input type="text" 
                       class="form-control form-control-sm bg-white" 
                       :value="montoSellado.toFixed(2)" 
                       readonly>
            </div>
        </div>

        <div class="row g-3">
            
            <div class="col-md-6">
                <label class="form-label fw-bold text-primary">Total a Pagar AHORA</label>
                <div class="input-group">
                    <span class="input-group-text bg-primary text-white border-primary">$</span>
                    <input type="text" 
                           class="form-control fw-bold text-primary border-primary bg-white" 
                           :value="totalPagarAhora.toFixed(2)" 
                           readonly>
                </div>
                <small class="text-muted fst-italic">Suma: Pago Lote + Honorarios + Sellado</small>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold text-danger">Saldo Lote a Pagar (en 48hs)</label>
                <div class="input-group">
                    <span class="input-group-text bg-danger text-white border-danger">$</span>
                    <input type="text" 
                           class="form-control fw-bold text-danger border-danger bg-white" 
                           :value="saldoRestante.toFixed(2)" 
                           readonly>
                </div>
                <small class="text-muted fst-italic">Resto del valor del lote</small>
            </div>

        </div>
    </div>
</div>

    <div class="modal-body">
        <div class="row">
            
            <div class="col-md-6 mb-3">
                <label for="nombre" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="nombre" name="nombre" required>
                <div class="invalid-feedback">El Nombre es obligatorio.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="apellido" class="form-label">Apellido</label>
                <input type="text" class="form-control" id="apellido" name="apellido" required>
                <div class="invalid-feedback">El Apellido es obligatorio.</div>
            </div>

            <div class="col-md-4 mb-3">
                <label for="tipo_dni" class="form-label">Tipo Dni</label>
                <input type="text" class="form-control" id="tipo_dni" name="tipo_dni" value="Dni" required>
                <div class="invalid-feedback">El Tipo Dni es obligatorio.</div>
            </div>
            <div class="col-md-8 mb-3">
                <label for="dni" class="form-label">Dni</label>
                <input type="text" class="form-control" id="dni" name="dni" required>
                <div class="invalid-feedback">El Dni es obligatorio.</div>
            </div>

            <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" required>
                <div class="invalid-feedback">El Email es obligatorio.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="telefono" class="form-label">Telefono</label>
                <input type="tel" class="form-control" id="telefono" name="telefono" required>
                <div class="invalid-feedback">El Telefono es obligatorio.</div>
            </div>

            <div class="col-12 mb-3">
                <label for="domicilio" class="form-label">Domicilio</label>
                <input type="text" class="form-control" id="domicilio" name="domicilio" required>
                <div class="invalid-feedback">El Domicilio es obligatorio.</div>
            </div>

            <div class="col-md-4 mb-3">
                <label for="codigo_postal" class="form-label">C.P.</label>
                <input type="text" class="form-control" id="codigo_postal" name="codigo_postal" required>
                <div class="invalid-feedback">El C.P. es obligatorio.</div>
            </div>
            <div class="col-md-8 mb-3">
                <label for="provincia" class="form-label">Provincia</label>
                <input type="text" class="form-control" id="provincia" name="provincia" required>
                <div class="invalid-feedback">El Provincia es obligatorio.</div>
            </div>

        </div> 
        </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar Recibo</button>
    </div>
</form>
    </div>
  </div>
</div>
@section Scripts {
<script>
    const appConfig = {
        data() {
            return {
                recibos: [],
                paginaActual: 1,
                totalPaginas: 0,
                busquedaLote: '',
                loteSeleccionado: null,
                errorBusqueda: null,
                cargando: false,
                resultadosBusqueda: [],
                textoBusqueda: '',
                timerBusqueda: null,
                //agregar recibo
                pagos: {
                gobierno: { 
                    efectivo: 0, transferencia: 0, 
                    dolar_monto: 0, dolar_cotizacion: 0, 
                    euro_monto: 0, euro_cotizacion: 0 
                },
                cmcpsl: { 
                    efectivo: 0, transferencia: 0, 
                    dolar_monto: 0, dolar_cotizacion: 0, 
                    euro_monto: 0, euro_cotizacion: 0 
                },
                dpip: { 
                    efectivo: 0, transferencia: 0, 
                    dolar_monto: 0, dolar_cotizacion: 0, 
                    euro_monto: 0, euro_cotizacion: 0 
                }
            },
            precioSubastado: 0,
            porcentajeLote: 30

            };
        },
    mounted() {
            this.cargarRecibo();
            
        },
    computed: {
       montoPagoLote() {
            let precio = parseFloat(this.precioSubastado) || 0;
            let porcentaje = parseFloat(this.porcentajeLote) || 0;
            return precio * (porcentaje / 100);
        },
        // 2. Calcula el 10% fijo de Honorarios
        montoHonorarios() {
            let precio = parseFloat(this.precioSubastado) || 0;
            return precio * 0.10;
        },
        // 3. Calcula el 0.6% fijo de Sellado
        montoSellado() {
            let precio = parseFloat(this.precioSubastado) || 0;
            return precio * 0.006;
        },// 4. Suma los tres anteriores para el total que debe poner la persona YA
        totalPagarAhora() {
            return this.montoPagoLote + this.montoHonorarios + this.montoSellado;
        },
        // 5. Calcula lo que falta pagar del lote (Total - lo que pagó del lote)
        saldoRestante() {
            let precio = parseFloat(this.precioSubastado) || 0;
            return precio - this.montoPagoLote;
        }
        },
    methods: {
        seleccionarLote(lote) {
                    this.loteSeleccionado = lote;      
                    this.busquedaLote = lote.numero;   
                    this.resultadosBusqueda = [];      
                    
                    console.log("Lote seleccionado:", this.loteSeleccionado);
                    
        },
        limpiarLote() {
            this.loteSeleccionado = null;
            this.busquedaLote = '';
            this.errorBusqueda = null;
            this.precioSubastado = 0
            this.porcentajeLote = 30;
            this.resetearFormasPago();
        },
        buscarConRetraso() {
                if (this.timerBusqueda) clearTimeout(this.timerBusqueda);
                
                this.timerBusqueda = setTimeout(() => {
                    this.paginaActual = 1; 
                    this.cargarRecibo();
                }, 500); 
            },
        cambiarPagina(nuevaPagina) {
            if (nuevaPagina >= 1 && nuevaPagina <= this.totalPaginas) {
                this.paginaActual = nuevaPagina;
                this.cargarRecibo();
            }
        },
        // --- Utilidades ---
        formatearFecha(fechaISO) {
            if (!fechaISO) return '';
            return new Date(fechaISO).toLocaleDateString('es-ES');
        },
        async cargarRecibo() {
                try {
                    
                    let url = `/api/reciboj?pagina=${this.paginaActual}`;
                    if (this.textoBusqueda) {
                        const valor = this.textoBusqueda.trim();

                        if (!isNaN(valor) && valor !== "") {
                            url += `&numeroLote=${encodeURIComponent(valor)}`;
                        } else {
                            url += `&razonSocial=${encodeURIComponent(valor)}`;
                        }
                    }
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Error al cargar los recibos');
                    const data = await response.json();
                    
                    this.recibos = data.recibos; 
                    this.totalPaginas = data.totalPaginas;
                    this.paginaActual = data.paginaActual;
                } catch (error) {
                    console.error('Error:', error);
                }
            },
            async buscarLote() {
                    if (!this.busquedaLote) return;
                    
                    this.cargando = true;
                    this.errorBusqueda = null;
                    this.resultadosBusqueda = []; 
                    this.loteSeleccionado = null; 

                    try {
                        
                        const response = await fetch(`/api/buscar/lotes/${encodeURIComponent(this.busquedaLote)}`);

                        if (response.ok) {
                            const data = await response.json();
                            
                            if (Array.isArray(data)) {
                                this.resultadosBusqueda = data;
                                
                                if (data.length === 0) {
                                    this.errorBusqueda = "No se encontraron coincidencias.";
                                }
                            } else {
                                this.resultadosBusqueda = [data];
                            }

                        } else {
                            if (response.status === 404) {
                                this.errorBusqueda = "No se encontró un lote con ese número.";
                            } else {
                                this.errorBusqueda = "Error al buscar el lote.";
                            }
                        }
                    } catch (error) {
                        console.error(error);
                        this.errorBusqueda = "Error de conexión con el servidor.";
                    } finally {
                        this.cargando = false;
                    }
                },
                resetearFormasPago() {
                    this.pagos = {
                        gobierno: { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
                        cmcpsl:   { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 },
                        dpip:     { efectivo: 0, transferencia: 0, dolar_monto: 0, dolar_cotizacion: 0, euro_monto: 0, euro_cotizacion: 0 }
                    };
                },

         }
           
    };

    const app = Vue.createApp(appConfig);
    window.appInstance = app.mount('#app');

</script>
<script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
}
