@{
    ViewData["Title"] = "Perfil";
}
<div id="app">
<div class="card mb-3 bg-light">
    <div class="card-body">
        <h1>Perfil</h1>
        <form  v-on:submit.prevent="ModificarPerfil" id="formModificarPerfil" class="needs-validation" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" name="id_usuario" v-model="usuario.id_usuario">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="nombre" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="nombre" name="nombre" v-model="usuario.nombre" required>
                <div class="invalid-feedback">El Nombre es obligatorio.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="apellido" class="form-label">Apellido</label>
                <input type="text" class="form-control" id="apellido" name="apellido" v-model="usuario.apellido" required>
                <div class="invalid-feedback">El Apellido es obligatorio.</div>
            </div>

            <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" v-model="usuario.email" required>
                <div class="invalid-feedback">El Email es obligatorio.</div>
            </div>
            <div class="col-12 mb-3 text-end">
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div> 
        </form>
    </div>
</div>




<div class="card mb-3 bg-light">
    <div class="card-body">
        <h1>Cambiar Imagen de Perfil</h1>
        <form v-on:submit.prevent="ModificarImagenPerfil" class="needs-validation" id="formModificarImagenUsuario" enctype="multipart/form-data" novalidate>
        @Html.AntiForgeryToken()
        <div class="row">
            <div class="col-md-12 mb-3">
                <span>Imagen actual:</span>
                <img src="@User.FindFirst("AvatarUrl")?.Value" id="perfilimagen2" class="rounded-circle me-2" alt="avatar" style="width: 32px; height: 32px;">
            </div>
            <div class="col-md-12 mb-3">
                <label for="AvatarFile" class="form-label">Avatar</label>
                <input class="form-control" id="avatarFile" name="avatarFile" type="file" required>
                <div class="invalid-feedback">El Avatar es obligatorio.</div>
            </div>
            <div class="col-12 mb-3 text-end">
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
        </form>
    </div>
</div>


<div class="card mb-3 bg-light">
    <div class="card-body">
        <h1>Cambiar Clave</h1>
        <form v-on:submit.prevent="ModificarClavePerfil" class="needs-validation" id="formModificarClaveUsuario" novalidate>
        @Html.AntiForgeryToken()
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="clave" class="form-label">Clave</label>
                <input class="form-control" id="clave" name="clave" type="text" v-model="usuario.clave" required>
                <div class="invalid-feedback">El Clave es obligatorio.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="oldClave" class="form-label">Clave Vieja</label>
                <input class="form-control" id="oldClave" name="oldClave" type="text" v-model="usuario.oldClave" required>
                <div class="invalid-feedback">El Clave Vieja es obligatorio.</div>
            </div>
            <div class="col-12 mb-3 text-end">
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
        </form>
    </div>
</div>



</div>


<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Sistema</strong>
      <small class="text-muted">justo ahora</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Cerrar"></button>
    </div>
    <div class="toast-body">
      @TempData["Mensaje"]
    </div>
  </div>
</div>
@section Scripts {
<script>
const appConfig = {
    data() {
        return {
            usuario: {
                id_usuario: 0,
                nombre: '',
                apellido: '',
                email: '',
                clave: '',
                oldClave: ''
            }
        };
    },
    mounted() {
        this.obtenerMiPerfil();
        const toastEl = document.getElementById('successToast');
        if (toastEl) this.toastBS = new bootstrap.Toast(toastEl);
    },
    methods: {
        obtenerMiPerfil() {
            fetch('/api/miperfil')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al obtener el perfil');
                    }
                    return response.json();
                })
                .then(data => {
                    this.usuario = data;
                })
                .catch(error => {
                    console.error('Hubo un problema:', error);
                    alert("No se pudieron cargar los datos del perfil.");
                });
        },
        
        async ModificarPerfil() {
            const form = document.getElementById('formModificarPerfil');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            form.classList.add('was-validated');
            console.log('Enviando datos:', this.usuario);
            try {
                const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                const token = tokenElement ? tokenElement.value : '';

                const response = await fetch('/api/actualizarperfil', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token 
                    },
                    body: JSON.stringify(this.usuario) 
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.mensaje || 'Error al procesar la solicitud.');
                }

                if (this.mostrarToast) {
                    this.mostrarToast(data.mensaje); 
                    document.getElementById("perfilemail").innerText = this.usuario.email;
                    this.limpiarformperfil();
                    this.obtenerMiPerfil();
                } else {
                    alert(data.mensaje);
                }

            } catch (error) {
                console.error('Error al modificar el perfil:', error);
                
                if (this.mostrarToast) {
                    this.obtenerMiPerfil();
                    this.mostrarToast(error.message);
                } else {
                    alert(error.message);
                }
            }
        },
        async ModificarImagenPerfil() {
            const form = document.getElementById('formModificarImagenUsuario');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            form.classList.add('was-validated');
            
            try {
                const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                const token = tokenElement ? tokenElement.value : '';

                const formData = new FormData();

                formData.append("id_usuario", this.usuario.id_usuario);

                const fileInput = document.getElementById('avatarFile');
                if (fileInput.files.length > 0) {
                    formData.append("avatarFile", fileInput.files[0]); 
                }

                const response = await fetch('/api/actualizarimagenperfil', {
                    method: 'PUT',
                    headers: {
                        'RequestVerificationToken': token 
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.mensaje || 'Error al procesar la solicitud.');
                }

                if (this.mostrarToast) {
                    this.mostrarToast(data.mensaje); 
                    //console.log(data.nuevaImagenUrl);
                    document.getElementById("perfilimagen").src = data.nuevaImagenUrl;
                    document.getElementById("perfilimagen2").src = data.nuevaImagenUrl;
                    this.limpiarformimagen();
                } else {
                    alert(data.mensaje);
                }

            } catch (error) {
                console.error('Error al modificar la imagen:', error);
                if (this.mostrarToast) {
                    this.mostrarToast(error.message);
                } else {
                    alert(error.message);
                }
            }
        },
        async ModificarClavePerfil() {
            const form = document.getElementById('formModificarClaveUsuario');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            form.classList.add('was-validated');
            
            try {
                const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                const token = tokenElement ? tokenElement.value : '';

                const formData = new FormData();

                const response = await fetch('/api/actualizarclaveperfil', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token 
                    },
                    body: JSON.stringify(this.usuario) 
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.mensaje || 'Error al procesar la solicitud.');
                }

                if (this.mostrarToast) {
                    this.mostrarToast(data.mensaje);
                    console.log(data.datos);
                    this.limpiarformclave()
                } else {
                    alert(data.mensaje);
                }

            } catch (error) {
                console.error('Error al modificar la clave:', error);
                if (this.mostrarToast) {
                    this.mostrarToast(error.message);
                    
                } else {
                    alert(error.message);
                }
            }
        },
        limpiarformclave() {
            this.usuario.clave = '';
            this.usuario.oldClave = '';

            const form = document.getElementById('formModificarClaveUsuario');
            if (form) {
                form.classList.remove('was-validated');
            }
        },
        limpiarformperfil() {
            
            const form = document.getElementById('formModificarPerfil');
            if (form) {
                form.classList.remove('was-validated');
            }
        },
        limpiarformimagen() {
            const form = document.getElementById('formModificarImagenUsuario');
            
            if (form) {
                form.classList.remove('was-validated');
                
                form.reset(); 
                
            }
        },
        mostrarToast(mensaje) {
            const toastBody = document.querySelector('#successToast .toast-body');
            if(toastBody) toastBody.textContent = mensaje;
            if(this.toastBS) this.toastBS.show();
        },
    }
};

const app = Vue.createApp(appConfig);
window.appInstance = app.mount('#app');
</script>
}